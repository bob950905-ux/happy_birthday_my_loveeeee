<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 2 (Ultimate Stability Fix)</title>
<style>
/* ê³µí†µ: í™”ë©´/ë¹„ë””ì˜¤ */
body{margin:0;background:#000;overflow:hidden;}
video{width:100vw;height:100vh;object-fit:contain;}

/* ëŒ€í™”ì°½(ê°„ë‹¨ë²„ì „) */
.dialog{display:none;}
.dialog.show{display:block!important;z-index:9999!important;}
.row{position:fixed;left:16px;right:16px;bottom:28px;display:flex;gap:12px;
     padding:14px;border-radius:16px;background:rgba(14,20,28,.9);
     color:#e9eef5;border:1px solid rgba(255,255,255,.12);}
.row .bubble{flex:1}
.row .bubble .name{font-weight:700;margin-bottom:6px}
.row .bubble .line{line-height:1.45}
.row .bubble #btns{margin-top:10px;display:flex;flex-direction:column;gap:10px}
.btn{display:block;text-align:center;padding:12px 16px;border-radius:12px;
     background:#1f2a3a;color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.16)}

/* íƒ­ì¹©(ì•ˆì •í™”) */
.tapchip{
  position:fixed!important;
  left:50%;
  bottom:110px;
  transform:translateX(-50%);
  display:none;
  padding:15px 30px;
  border-radius:999px;
  background:rgba(20,28,38,.9);
  color:#fff;
  font-weight:700;
  font-size:1.2rem;
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);
  z-index:10002!important;
  width:auto!important;height:auto!important;
}
.tapchip:active{transform:translateX(-50%) scale(.96);}

/* START íŒíŠ¸ëŠ” íƒ­ì¹© ì•„ë˜ ë ˆì´ì–´ */
#hint{position:fixed;left:50%;top:18px;transform:translateX(-50%);
      padding:10px 14px;border-radius:12px;background:rgba(20,28,38,.9);
      color:#fff;border:1px solid rgba(255,255,255,.15);z-index:10001!important;}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene2_wine.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div id="hint">ğŸ¬ START!</div>
  <div id="tap" class="tapchip">íƒ­!</div>

  <div id="dialog" class="dialog">
    <div class="row">
      <img id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"
           style="width:60px;height:60px;border-radius:50%;object-fit:cover;"/>
      <div class="bubble">
        <div id="name" class="name">ì„±ìš°</div>
        <div id="line" class="line"></div>
        <div id="btns"></div>
      </div>
    </div>
  </div>
</div>

<script>
const vid   = document.getElementById('vid');
const hint  = document.getElementById('hint');
const tap   = document.getElementById('tap');
const dialog= document.getElementById('dialog');
const avatar= document.getElementById('avatar');
const nameEl= document.getElementById('name');
const line  = document.getElementById('line');
const btns  = document.getElementById('btns');

let tapAction = null, tapGuard = false;

/* íƒ­ì¹©: ëˆŒë €ì„ ë•Œë§Œ ì§„í–‰ */
function setTap(next){ tapAction = next; tap.style.display='inline-flex'; }
function clearTap(){ tapAction = null; tap.style.display='none'; }

function onTap(){
  if(tapGuard) return;
  tapGuard = true; setTimeout(()=>tapGuard=false,200);
  const fn = tapAction; clearTap(); if(typeof fn==='function') fn();
}
tap.addEventListener('click', onTap);
tap.addEventListener('touchend', (e)=>{ e.preventDefault(); onTap(); });

/* START: ì²« ì…ë ¥ ì‹œ íŒíŠ¸ ìˆ¨ê¸°ê³  ì¬ìƒ ì‹œë„ */
function setupStart(){
  hint.style.display='block';
  const start = ()=>{
    hint.style.display='none';
    vid.muted = true; vid.playsInline = true;
    vid.play().catch(()=>{ setTap(()=>vid.play()); });
    ['click','touchend','pointerdown'].forEach(ev=>document.removeEventListener(ev,start));
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

/* ëŒ€í™” í‘œì‹œ */
function showDialog(text, who='ì„±ìš°', avatarSrc='./assets/avatar_seongwoo.png'){
  dialog.classList.add('show');
  avatar.src = avatarSrc;
  nameEl.textContent = who;
  line.textContent = text;
  btns.innerHTML = '';
}

/* ì‹¤í–‰ */
setupStart();

vid.addEventListener('ended', ()=>{
  // 1
  showDialog('ì™€ì¸â€¦? ì´ëŸ° ë° ì™œ ìˆì§€?');
  setTap(()=>{
    // 2
    showDialog('íƒœì´ê°€ ìˆ¨ê²¨ë‘” ê±´ê°€ ë´.');
    setTap(()=>{
      // 3
      showDialog('ì´ê±° ë§ˆì‹œë©´ ë”± ì¢‹ê² ë‹¤.');
      setTap(()=>{
        // 4 ì„ íƒì§€
        clearTap();
        const o = document.createElement('a'); o.className='btn'; o.textContent='ì™€ì¸ë°” ê°€ì„œ ë¶„ìœ„ê¸° ìˆê²Œ ë§ˆì‹œì! ğŸ¥‚';
        const x = document.createElement('a'); x.className='btn'; x.textContent='ì§‘ì—ì„œ ì˜¤ë¶“í•˜ê²Œ ë§ˆì‹œëŠ” ê²Œ ì¢‹ì•„! ğŸ’–';
        btns.append(o,x);

        function choose(e){
          e.preventDefault();
          btns.innerHTML='';
          // í™•ì • ëŒ€ì‚¬
          showDialog('ì¢‹ì•„! ê·¸ë ‡ê²Œ í•˜ì! íƒœì´ë‘ í•¨ê»˜ë¼ë©´ ì–´ë””ë“  ì¢‹ì•„!');
          // ë‹¤ìŒ ë²„íŠ¼ (íƒ­ìœ¼ë¡œ ë…¸ì¶œ)
          setTap(()=>{
            clearTap();
            const home = document.createElement('a');
            home.href='./index.html';
            home.className='btn';
            home.textContent='ë‹¤ìŒ ì„ ë¬¼ ê³ ë¥´ëŸ¬ ê°€ê¸° ğŸ';
            btns.appendChild(home);
          });
        }
        o.addEventListener('click', choose, {once:true});
        x.addEventListener('click', choose, {once:true});
      });
    });
  });
},{once:true});
</script>
</body>
</html>
