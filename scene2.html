<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 2 (Final Stable - Fixed Tap System)</title>
<link rel="stylesheet" href="./assets/ui.css"/>
<style>
  .dialog { display:none; }
  .dialog.show { display:block!important; z-index:9999; }

  /* íƒ­ì¹©ì„ ëŒ€í™”ì°½ ìœ„ë¡œ ë‚´ë¦¬ê³  í¬ê¸°ë„ í‚¤ì›€ */
  .tapchip{
    position: fixed;
    left: 50%;
    bottom: 110px;           /* í•„ìš”í•˜ë©´ 90~130pxë¡œ ë¯¸ì„¸ì¡°ì • */
    transform: translateX(-50%);
    display: none;
    padding: 12px 18px;
    border-radius: 999px;
    background: rgba(20,28,38,.9);
    color: #fff;
    font-weight: 700;
    font-size: 1rem;
    border: 1px solid rgba(255,255,255,.15);
    box-shadow: 0 4px 18px rgba(0,0,0,.35);
    user-select: none; -webkit-user-select: none;
    transition: bottom .2s ease;
  }
  .tapchip:active{ transform: translateX(-50%) scale(.96); }
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene2_wine.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>

  <div class="dialog" id="dialog">
    <div class="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>

  <div class="hearts" id="hearts"></div>
</div>

<script>
/* --------------- ìš”ì†Œ --------------- */
const vid    = document.getElementById('vid');
const hint   = document.getElementById('hint');
const tapEl  = document.getElementById('tap');
const dialog = document.getElementById('dialog');
const avatar = document.getElementById('avatar');
const nameEl = document.getElementById('name');
const lineEl = document.getElementById('line');
const btns   = document.getElementById('btns');

/* ============== TAP ì „ìš© ì§„í–‰ ============== */
let tapAction=null, tapGuard=false;

function setTap(next, label='íƒ­!'){
  tapAction = next;
  tapEl.textContent = label;
  tapEl.style.display = 'inline-flex';
}
function clearTap(){
  tapAction = null;
  tapEl.style.display = 'none';
}
function onTap(e){
  if(e.target!==tapEl) return;               // ì¹©ë§Œ í—ˆìš©
  e.preventDefault(); e.stopPropagation();
  if(tapGuard) return; tapGuard=true; setTimeout(()=>tapGuard=false,200);
  const fn = tapAction; clearTap();
  if(typeof fn==='function') fn();
}
tapEl.addEventListener('touchend', onTap, {passive:false});
tapEl.addEventListener('click',    onTap, {passive:false});
window.addEventListener('click',(e)=>{ if(e.target!==tapEl) e.stopPropagation(); }, {capture:true});

/* ============== START & ì¬ìƒ ============== */
function setupStart(video, startHint){
  startHint.style.display='none';
  video.addEventListener('canplay',()=>{ startHint.style.display='block'; }, {once:true});

  const begin=()=>{
    startHint.style.display='none';
    video.muted=true; video.playsInline=true;
    video.play().catch(()=>{ setTap(()=>video.play(),'íƒ­!'); });
  };
  ['pointerdown','touchend','click'].forEach(ev=>{
    document.addEventListener(ev, begin, {once:true, passive:true});
  });
}

/* ============== ëŒ€í™”ì°½ ============== */
function showDialog(text, avatarSrc='./assets/avatar_seongwoo.png', who='ì„±ìš°'){
  dialog.classList.add('show');
  avatar.src = avatarSrc;
  nameEl.textContent = who;
  lineEl.textContent = text;
  btns.innerHTML = '';
}

/* --------------- ì‹¤í–‰ --------------- */
setupStart(vid, hint);

/* ë¹„ë””ì˜¤ ë â†’ íƒ­ì¹©ìœ¼ë¡œ ë‹¨ê³„ ì§„í–‰ */
vid.addEventListener('ended', ()=>{
  // 1) â€œì—¬ê¸°â€¦ ì™€ì¸ì´ë„¤?â€
  setTap(()=>{
    showDialog('ì—¬ê¸°â€¦ ì™€ì¸ì´ë„¤?');

    // 2) â€œíƒœì´ê°€ ìˆ¨ê²¨ë‘” ê±´ê°€ ë´.â€
    setTap(()=>{
      showDialog('íƒœì´ê°€ ìˆ¨ê²¨ë‘” ê±´ê°€ ë´.');

      // 3) â€œì´ê±° ë§ˆì‹œë©´ ë”± ì¢‹ê² ë‹¤.â€
      setTap(()=>{
        showDialog('ì´ê±° ë§ˆì‹œë©´ ë”± ì¢‹ê² ë‹¤.');

        // 4) ì„ íƒì§€ ë²„íŠ¼ (ëŒ€ì‚¬ ì—†ì´)
        btns.innerHTML='';
        const o = document.createElement('a');
        const x = document.createElement('a');
        o.className='btn'; o.textContent='ì™€ì¸ë°” ê°€ì„œ ë¶„ìœ„ê¸° ìˆê²Œ ë§ˆì‹œì! ğŸ¥‚';
        x.className='btn'; x.textContent='ì§‘ì—ì„œ ì˜¤ë¶“í•˜ê²Œ ë§ˆì‹œëŠ” ê²Œ ì¢‹ì•„! ğŸ’–';
        btns.append(o,x);

        // 5) ì„ íƒ í™•ì • â†’ í™•ì • ëŒ€ì‚¬ â†’ ë‹¤ìŒ ì„ ë¬¼ ë²„íŠ¼
        function choose(){
          showDialog('ì¢‹ì•„! ê·¸ë ‡ê²Œ í•˜ì! íƒœì´ë‘ í•¨ê»˜ë¼ë©´ ì–´ë””ë“  ì¢‹ì•„!');
          setTap(()=>{
            btns.innerHTML='';
            const home=document.createElement('a');
            home.href='./index.html';
            home.className='btn';
            home.textContent='ë‹¤ìŒ ì„ ë¬¼ ê³ ë¥´ëŸ¬ ê°€ê¸° ğŸ';
            btns.appendChild(home);
          });
        }
        o.addEventListener('click', (e)=>{ e.preventDefault(); choose(); }, {once:true});
        x.addEventListener('click', (e)=>{ e.preventDefault(); choose(); }, {once:true});
      });
    });
  });
},{once:true});
</script>
</body>
</html>
