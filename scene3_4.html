<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 3+4 (Final Working Version)</title>

<link rel="stylesheet" href="./assets/ui.css"/> 

<style>
/* --- í•„ìˆ˜ ìŠ¤íƒ€ì¼ (ui.cssê°€ ì—†ê±°ë‚˜ ì¶©ëŒ ì‹œ í•„ìš”) --- */
/* ğŸ–¼ï¸ ëŒ€í™”ì°½ì´ í™•ì‹¤íˆ ë³´ì´ë„ë¡ CSS í´ë˜ìŠ¤ ì •ì˜ */
.dialog {
    display: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out;
}
.dialog.show {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    z-index: 9999 !important;
}

/* ğŸ’– í•˜íŠ¸ê°€ ìœ„ì—ì„œ ì•„ë˜ë¡œ ë–¨ì–´ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
@keyframes fall {
    0% { transform: translateY(-10vh) scale(1); opacity: 1; } /* í™”ë©´ ìœ„ì—ì„œ ì‹œì‘ */
    100% { transform: translateY(100vh) scale(0.5); opacity: 0; } /* í™”ë©´ ì•„ë˜ë¡œ ë–¨ì–´ì§€ë©° ì‚¬ë¼ì§ */
}
.hearts span {
    position: absolute; 
    pointer-events: none; 
}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene3_taei.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>
  <div class="dialog" id="dialog">
    <div class="row" id="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble" id="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>
  <div class="hearts" id="hearts"></div>
</div>
<script>
// --- ì „ì—­ ìš”ì†Œ ì •ì˜ ---
const vid = document.getElementById('vid'); 
const hint = document.getElementById('hint'); 
const tap = document.getElementById('tap');
const dialog = document.getElementById('dialog'); 
const avatar = document.getElementById('avatar'); 
const nameEl = document.getElementById('name');
const line = document.getElementById('line'); 
const btns = document.getElementById('btns'); 
const hearts = document.getElementById('hearts');

// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

/** íƒ­ ëŒ€ê¸° í•¨ìˆ˜ */
function awaitTapOnce(next){
  tap.style.display='block'; 
  const fn=(e)=>{ 
    if(e.target.closest && e.target.closest('.btn')) return;
    document.removeEventListener('click',fn); 
    document.removeEventListener('touchend',fn); 
    tap.style.display='none'; 
    next(); 
  };
  document.addEventListener('click',fn,{passive:true});
  document.addEventListener('touchend',fn,{passive:true});
}

/** ğŸ’– í•˜íŠ¸ê°€ ìœ„ì—ì„œ ë–¨ì–´ì§€ëŠ” í•¨ìˆ˜ */
function heartBurst(container){
  container.innerHTML='';
  for(let i=0;i<10;i++){
    const s=document.createElement('span'); s.textContent='â¤'; 
    s.style.position='absolute'; 
    s.style.left=(Math.random()*80)+'vw'; 
    s.style.top='-50px'; 
    s.style.animation='fall 1.5s linear forwards'; 
    container.appendChild(s);
  }
  setTimeout(()=>container.innerHTML='',1600);
}

/** ì‹œì‘ ì„¤ì • í•¨ìˆ˜ */
function setupStart(vid,hint){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none'; 
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=>{ tap.style.display='block'; });
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

/** ëŒ€í™”ì°½ í‘œì‹œ ë° ë‚´ìš© ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
function updateDialog(name, avatarSrc, text, hideTapChip=false){
    dialog.classList.add('show');
    dialog.style.zIndex = '9999'; 
    avatar.src = avatarSrc;
    nameEl.textContent = name;
    line.textContent = text;
    btns.innerHTML = '';
    if(hideTapChip) tap.style.display = 'none';
}

function startScene3Dialogs(){
  updateDialog('ì„±ìš°', './assets/avatar_seongwoo.png', 'ì–´? íƒœì´ë‹¤~~~~~', true);
  
  awaitTapOnce(()=>{
    updateDialog('íƒœì´', './assets/avatar_taei.png', 'ì•„ê°€~~~~ ìƒì¼ì¶•í•˜í•´!! â¤ï¸');
    awaitTapOnce(()=>{
      line.textContent = 'ë‚´ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì¤„ ì„ ë¬¼ì€ ...!';
      awaitTapOnce(()=>{ 
        dialog.classList.remove('show');
        playScene4(); 
      });
    });
  });
}

// --- Scene 4 ë¡œì§ ---
let v2 = null; 

function playScene4(){
  tap.style.display='none'; 
  if (vid.parentNode) vid.parentNode.removeChild(vid); 

  v2=document.createElement('video');
  v2.src='./scene4_ticket.mp4';
  v2.playsInline=true; v2.muted=true; v2.preload='auto';
  Object.assign(v2.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',background:'#000'});
  document.querySelector('.stage').appendChild(v2);
  v2.play().catch(()=>{ tap.style.display='block'; });

  let done=false;
  const finish=()=>{
    if(done) return; done=true;
    
    // ğŸ–¼ï¸ Scene 4 ë°°ê²½ ìœ ì§€: PNG íŒŒì¼ ì°¸ì¡°
    // ë°°ê²½ ì´ë¯¸ì§€ íŒŒì¼ì´ 'scene4_ticket.png'ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
    const lastFrameUrl = v2.src.replace('.mp4', '.png'); 
    const stageEl = document.querySelector('.stage');
    stageEl.style.backgroundImage = `url('${lastFrameUrl}')`;
    stageEl.style.backgroundSize = 'contain'; 
    stageEl.style.backgroundRepeat = 'no-repeat';
    stageEl.style.backgroundPosition = 'center';

    // ì˜ìƒ ìš”ì†Œ ì œê±°
    if (v2.parentNode) {
        v2.parentNode.removeChild(v2); 
        v2 = null; 
    }

    // ëŒ€ì‚¬ ë°”ë¡œ í‘œì‹œ 
    updateDialog('íƒœì´', './assets/avatar_taei.png', 'íƒœì´ë‘ ê°™ì´ ì œì£¼ë„ ê°€ì~!!! âœˆï¸');
    btns.innerHTML='';

    // íƒ­ì„ ê¸°ë‹¤ë ¤ ì„ íƒì§€ ë²„íŠ¼ì„ í‘œì‹œ
    awaitTapOnce(()=>{ 
      const o=document.createElement('a'); o.className='btn'; o.textContent='íƒœì´ë‘ í•¨ê»˜í• ë˜~ ğŸ’–';
      const x=document.createElement('a'); x.className='btn'; x.textContent='ë„˜ ê°‘ì‘ìŠ¤ëŸ¬ì›Œì„œ ì•ˆê°ˆë˜ìš”! ğŸ˜­';
      btns.append(o,x);
      
      // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      o.onclick=(e)=>{ 
        e.preventDefault(); 
        btns.innerHTML=''; 
        updateDialog('íƒœì´', './assets/avatar_taei.png', 'íƒœì´í•œí…Œ ë½€ë½€~ (í•˜íŠ¸)');
        heartBurst(hearts); 
        awaitTapOnce(()=>location.href='./index.html'); 
      };
      x.onclick=(e)=>{ 
        e.preventDefault(); 
        btns.innerHTML=''; 
        updateDialog('íƒœì´', './assets/avatar_taei.png', 'ë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘');
        awaitTapOnce(()=>location.href='./index.html'); 
      };
    });
  };

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì˜ìƒ ì¢…ë£Œ ì‹œ finish ì‹¤í–‰
  v2.addEventListener('ended', finish, {once:true});
  v2.addEventListener('timeupdate', ()=>{
    if(!done && v2.duration && v2.currentTime >= v2.duration - 0.2) finish();
  });
}

// --- ì´ˆê¸° ì‹¤í–‰ ---
setupStart(vid,hint);
vid.addEventListener('ended', startScene3Dialogs, {once:true});
</script>
</body>
</html>
