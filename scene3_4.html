<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 3 + 4 (Stable Full Version)</title>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:sans-serif;}
video,img.bg{width:100vw;height:100vh;object-fit:contain;background:#000;position:absolute;inset:0;}

/* START ë²„íŠ¼ */
#hint{
  position:fixed;left:50%;top:18px;transform:translateX(-50%);
  padding:10px 14px;border-radius:999px;background:rgba(20,28,38,.9);
  color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);z-index:10001;
}

/* íƒ­ì¹© */
.tapchip{
  position:fixed!important;left:50%;bottom:110px;transform:translateX(-50%);
  display:none;padding:15px 30px;border-radius:999px;background:rgba(20,28,38,.9);
  color:#fff;font-weight:700;font-size:1.2rem;border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);z-index:10002!important;
  width:auto!important;height:auto!important;white-space:nowrap;
}
.tapchip:active{transform:translateX(-50%) scale(.96);}

/* ëŒ€í™”ì°½ */
.dialog{display:none;}
.dialog.show{display:block!important;z-index:9999!important;}
.row{position:fixed;left:16px;right:16px;bottom:28px;display:flex;gap:12px;
     padding:14px;border-radius:16px;background:rgba(14,20,28,.9);
     color:#e9eef5;border:1px solid rgba(255,255,255,.12);}
.row .bubble{flex:1}
.row .bubble .name{font-weight:700;margin-bottom:6px}
.row .bubble .line{line-height:1.45}
.row .bubble #btns{margin-top:10px;display:flex;flex-direction:column;gap:10px}
.btn{display:block;text-align:center;padding:12px 16px;border-radius:12px;
     background:#1f2a3a;color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.16)}

/* í•˜íŠ¸ ì´í™íŠ¸ */
.hearts span{
  position:absolute;pointer-events:none;left:0;top:0;
  transform:translate(-50%,-50%);font-size:22px;
  animation:fall 1.5s linear forwards;
}
@keyframes fall{
  0%{transform:translateY(-10vh) scale(1);opacity:1;}
  100%{transform:translateY(100vh) scale(.5);opacity:0;}
}
</style>
</head>
<body>
<div class="stage">
  <video id="v1" src="./scene3_taei.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div id="hint">ğŸ¬ START!</div>
  <div id="tap" class="tapchip">íƒ­!</div>

  <div id="dialog" class="dialog">
    <div class="row">
      <img id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"
           style="width:60px;height:60px;border-radius:50%;object-fit:cover;"/>
      <div class="bubble">
        <div id="name" class="name">ì„±ìš°</div>
        <div id="line" class="line"></div>
        <div id="btns"></div>
      </div>
    </div>
  </div>
  <div id="hearts" class="hearts"></div>
</div>

<script>
const v1=document.getElementById('v1');
const hint=document.getElementById('hint');
const tap=document.getElementById('tap');
const dialog=document.getElementById('dialog');
const avatar=document.getElementById('avatar');
const nameEl=document.getElementById('name');
const line=document.getElementById('line');
const btns=document.getElementById('btns');
const hearts=document.getElementById('hearts');

let tapAction=null,tapGuard=false;
function setTap(next){tapAction=next;tap.style.display='inline-flex';}
function clearTap(){tapAction=null;tap.style.display='none';}
function fireTap(){
  if(tapGuard)return;
  tapGuard=true;setTimeout(()=>tapGuard=false,150);
  const fn=tapAction;clearTap();if(typeof fn==='function')fn();
}
tap.addEventListener('click',fireTap);
tap.addEventListener('touchend',e=>{e.preventDefault();fireTap();});

/* START */
function setupStart(){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none';
    v1.muted=true;v1.playsInline=true;
    v1.play().catch(()=>setTap(()=>v1.play()));
    ['click','touchend','pointerdown'].forEach(ev=>document.removeEventListener(ev,start));
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

/* ëŒ€í™” */
function say(who,face,text){
  dialog.classList.add('show');
  avatar.src=face;
  nameEl.textContent=who;
  line.textContent=text;
  btns.innerHTML='';
}

/* í•˜íŠ¸ */
function heartBurst(){
  hearts.innerHTML='';
  for(let i=0;i<12;i++){
    const s=document.createElement('span');
    s.textContent='â¤';
    s.style.left=(10+Math.random()*80)+'vw';
    s.style.top='-40px';
    hearts.appendChild(s);
  }
  setTimeout(()=>hearts.innerHTML='',1600);
}

/* ì”¬3 */
function runScene3(){
  say('ì„±ìš°','./assets/avatar_seongwoo.png','ì–´? íƒœì´ë‹¤~~~~~');
  setTap(()=>{
    say('íƒœì´','./assets/avatar_taei.png','ì•„ê°€, ìƒì¼ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•´! ğŸ‚ ë„¤ê°€ ì´ë ‡ê²Œ í–‰ë³µí•´í•˜ëŠ” ê±° ë³´ë‹ˆê¹Œ ë‚˜ë„ ë„ˆë¬´ ì¢‹ì•„.');
    setTap(()=>{
      say('íƒœì´','./assets/avatar_taei.png','ê·¸ë¦¬ê³ ... ë§ˆì§€ë§‰ ë‚´ ì„ ë¬¼ì€...... ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ğŸ¥');
      setTap(()=>{
        say('íƒœì´','./assets/avatar_taei.png','ë°”ë¡œ ë‚˜ì•¼!!! ğŸ’–');
        setTap(()=>{
          say('íƒœì´','./assets/avatar_taei.png','íˆíˆ ë‚˜ë„ ì„ ë¬¼ì´ê³ ! ì§„ì§œ ë§ˆì§€ë§‰ ì„ ë¬¼ì€.....!');
          setTap(()=>{
            dialog.classList.remove('show');
            playScene4();
          });
        });
      });
    });
  });
}

/* ì”¬4 */
let v2=null;
function playScene4(){
  v2=document.createElement('video');
  v2.src='./scene4_ticket.mp4';
  v2.playsInline=true;v2.muted=true;v2.preload='auto';
  Object.assign(v2.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',background:'#000',zIndex:1});
  const stage=document.querySelector('.stage');
  stage.appendChild(v2);

  const old=document.getElementById('v1');
  if(old&&old.parentNode)old.parentNode.removeChild(old);
  v2.play().catch(()=>setTap(()=>v2.play()));

  let done=false;
  const finish=()=>{
    if(done)return;done=true;
    const bg=document.createElement('img');
    bg.src='./scene4_ticket.png';
    Object.assign(bg.style,{
      position:'absolute',inset:'0',width:'100vw',height:'100vh',
      objectFit:'contain',zIndex:1,pointerEvents:'none'
    });
    stage.appendChild(bg);
    if(v2.parentNode)v2.parentNode.removeChild(v2);
    v2=null;

    say('íƒœì´','./assets/avatar_taei.png','ìš°ë¦¬ ê°™ì´ ë– ë‚˜ì, ìê¸°ì•¼! âœˆï¸');
    setTap(()=>{
      say('ì„±ìš°','./assets/avatar_seongwoo.png','í—... ì™„ì „ ê°ë™ì´ì•¼. ë‚´ ë§ˆìŒì€ ì´ë¯¸ ì¶œë°œí–ˆëŠ”ë°?');
      setTap(()=>{
        clearTap();
        const o=document.createElement('a');o.className='btn';o.textContent='ê³ ë¯¼ì€ ë¬´ìŠ¨! ë‹¹ì¥ íƒœì´ ì† ì¡ê³  ë– ë‚ ë˜~ ğŸ’–';
        const x=document.createElement('a');x.className='btn';x.textContent='ì ê¹! ë„ˆë¬´ ê°‘ì‘ìŠ¤ëŸ¬ì›Œ... ë‹¤ìŒì— ê°ˆë˜ìš”! ğŸ˜­';
        btns.append(o,x);
        o.onclick=e=>{
          e.preventDefault();
          say('íƒœì´','./assets/avatar_taei.png','íƒœì´í•œí…Œ ë½€ë½€~ğŸ’‹ ì™„ë²½í•œ ì„ íƒ! ìš°ë¦¬ ê°€ì„œ ë§›ìˆëŠ” ê±° ì”ëœ© ë¨¹ê³  ì˜¤ì~!');
          heartBurst();
          setTap(()=>{clearTap();const home=document.createElement('a');home.href='./index.html';home.className='btn';home.textContent='ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°';btns.appendChild(home);});
        };
        x.onclick=e=>{
          e.preventDefault();
          say('íƒœì´','./assets/avatar_taei.png','ë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘ ğŸ¥º ë‹¤ìŒì—” ê¼­ ê°™ì´ ê°€ì~ ì•½ì†ì´ì•¼!');
          setTap(()=>{clearTap();const home=document.createElement('a');home.href='./index.html';home.className='btn';home.textContent='ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°';btns.appendChild(home);});
        };
      });
    });
  };

  // ì¢…ë£Œ ê°ì‹œ
  v2.addEventListener('ended',finish,{once:true});
  let poll=null;
  const check=()=>{if(poll)return;poll=setInterval(()=>{const d=v2.duration;if((isFinite(d)&&d>0&&v2.currentTime>=d-0.15)||v2.ended)finish();},150);};
  v2.addEventListener('loadedmetadata',check,{once:true});
  v2.addEventListener('playing',check,{once:true});
  setTimeout(()=>finish(),20000);
}

setupStart();
v1.addEventListener('ended',runScene3,{once:true});
</script>
</body>
</html>
