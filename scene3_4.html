<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 3+4 (Final)</title>
<link rel="stylesheet" href="./assets/ui.css"/>
<style>
/* CSS ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ dialogë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¸°ë˜, 
   ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ opacityì™€ transitionì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„í•©ë‹ˆë‹¤. 
   ë§Œì•½ ui.cssì— ì´ë¯¸ dialogì— display:noneì´ ìˆë‹¤ë©´ ì´ ë¶€ë¶„ì€ ì œê±°í•´ë„ ë©ë‹ˆë‹¤. */
.dialog {
    display: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out;
}
.dialog.show {
    display: block;
    opacity: 1;
    visibility: visible;
}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene3_taei.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>
  <div class="dialog" id="dialog">
    <div class="row" id="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble" id="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>
  <div class="hearts" id="hearts"></div>
</div>
<script>
// --- ì „ì—­ ìš”ì†Œ ì •ì˜ ---
const vid = document.getElementById('vid'); 
const hint = document.getElementById('hint'); 
const tap = document.getElementById('tap');
const dialog = document.getElementById('dialog'); 
const avatar = document.getElementById('avatar'); 
const nameEl = document.getElementById('name');
const line = document.getElementById('line'); 
const btns = document.getElementById('btns'); 
const hearts = document.getElementById('hearts');

// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

/** íƒ­ ëŒ€ê¸° í•¨ìˆ˜: document ì „ì²´ì— ë¦¬ìŠ¤ë„ˆë¥¼ ê±¸ì–´ í™•ì‹¤í•˜ê²Œ ì´ë²¤íŠ¸ë¥¼ ì¡ìŠµë‹ˆë‹¤. */
function awaitTapOnce(next){
  // íƒ­ì¹©ì„ ë„ì›Œ ì‚¬ìš©ìì—ê²Œ íƒ­ì„ ìœ ë„í•©ë‹ˆë‹¤.
  tap.style.display='block'; 
  
  const fn=(e)=>{ 
    // .btn ìš”ì†Œë¥¼ í´ë¦­í•œ ê²½ìš°ë¥¼ ì œì™¸
    if(e.target.closest && e.target.closest('.btn')) return;
    
    // ë¦¬ìŠ¤ë„ˆ ì œê±° ë° íƒ­ì¹© ìˆ¨ê¹€
    document.removeEventListener('click',fn); 
    document.removeEventListener('touchend',fn); 
    tap.style.display='none'; 
    next(); 
  };
  
  document.addEventListener('click',fn,{passive:true});
  document.addEventListener('touchend',fn,{passive:true});
}

/** í•˜íŠ¸ ì´í™íŠ¸ í•¨ìˆ˜ (ë™ì¼) */
function heartBurst(container){
  container.innerHTML='';
  for(let i=0;i<10;i++){
    const s=document.createElement('span'); s.textContent='â¤'; s.style.position='relative';
    s.style.left=(Math.random()*80-40)+'px'; s.style.animation='rise 1.5s linear forwards';
    container.appendChild(s);
  }
  setTimeout(()=>container.innerHTML='',1600);
}

/** ì‹œì‘ ì„¤ì • í•¨ìˆ˜ (ë™ì¼) */
function setupStart(vid,hint){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none'; 
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=>{ tap.style.display='block'; });
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

// --- Scene 3 ë‹¤ì´ì–¼ë¡œê·¸ ë¡œì§ ---

/** ëŒ€í™”ì°½ í‘œì‹œ ë° ë‚´ìš© ì—…ë°ì´íŠ¸ */
function updateDialog(name, avatarSrc, text, hideTapChip=false){
    // CSS í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€í™”ì°½ í‘œì‹œë¥¼ í™•ì‹¤íˆ í•©ë‹ˆë‹¤.
    dialog.classList.add('show');
    dialog.style.zIndex = '9999'; // ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ì˜¬ë¼ì˜¤ë„ë¡ z-index ì„¤ì •
    avatar.src = avatarSrc;
    nameEl.textContent = name;
    line.textContent = text;
    btns.innerHTML = '';
    if(hideTapChip) tap.style.display = 'none';
}

function startScene3Dialogs(){
  // ëŒ€í™” ì‹œí€€ìŠ¤ë¥¼ ëª…í™•í•˜ê²Œ ì¬êµ¬ì„±
  updateDialog('ì„±ìš°', './assets/avatar_seongwoo.png', 'ì–´? íƒœì´ë‹¤~~~~~', true);
  
  awaitTapOnce(()=>{
    updateDialog('íƒœì´', './assets/avatar_taei.png', 'ì•„ê°€~~~~ ìƒì¼ì¶•í•˜í•´!! â¤ï¸');
    awaitTapOnce(()=>{
      updateDialog('íƒœì´', './assets/avatar_taei.png', 'ë‚´ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì¤„ ì„ ë¬¼ì€ ...!');
      awaitTapOnce(()=>{ 
        dialog.classList.remove('show');
        playScene4(); 
      });
    });
  });
}

// --- Scene 4 ë¡œì§ ---

let v2 = null; // v2 ì˜ìƒì„ ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬

function playScene4(){
  // ê¸°ì¡´ ì˜ìƒ ìš”ì†Œ ì œê±° ë° tapchip ìˆ¨ê¹€
  tap.style.display='none'; 
  if (vid.parentNode) vid.parentNode.removeChild(vid); // Scene 3 ì˜ìƒ ì œê±°

  v2=document.createElement('video');
  v2.src='./scene4_ticket.mp4';
  v2.playsInline=true; v2.muted=true; v2.preload='auto';
  Object.assign(v2.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',background:'#000'});
  document.querySelector('.stage').appendChild(v2);
  v2.play().catch(()=>{ tap.style.display='block'; });

  let done=false;
  const finish=()=>{
    if(done) return; done=true;
    
    // ğŸš¨ í•µì‹¬ ìˆ˜ì •: ì˜ìƒì´ ëë‚˜ë©´ v2ë¥¼ DOMì—ì„œ ì œê±°í•˜ì—¬ í™”ë©´ì„ ê°€ë¦¬ëŠ” ë¬¸ì œ í•´ê²°
    if (v2.parentNode) {
        v2.parentNode.removeChild(v2); 
        v2 = null; // ì°¸ì¡° ì œê±°
    }

    // ëŒ€ì‚¬ ë°”ë¡œ í‘œì‹œ (Scene 4-1)
    updateDialog('íƒœì´', './assets/avatar_taei.png', 'íƒœì´ë‘ ê°™ì´ ì œì£¼ë„ ê°€ì~!!! âœˆï¸');
    btns.innerHTML='';

    // íƒ­ì„ ê¸°ë‹¤ë ¤ ì„ íƒì§€ ë²„íŠ¼ì„ í‘œì‹œ (Scene 4-2)
    awaitTapOnce(()=>{ 
      const o=document.createElement('a'); o.className='btn'; o.textContent='íƒœì´ë‘ í•¨ê»˜í• ë˜~ ğŸ’–';
      const x=document.createElement('a'); x.className='btn'; x.textContent='ë„˜ ê°‘ì‘ìŠ¤ëŸ¬ì›Œì„œ ì•ˆê°ˆë˜ìš”! ğŸ˜­';
      btns.append(o,x);
      
      // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      o.onclick=(e)=>{ 
        e.preventDefault(); 
        btns.innerHTML=''; 
        updateDialog('íƒœì´', './assets/avatar_taei.png', 'íƒœì´í•œí…Œ ë½€ë½€~ (í•˜íŠ¸)');
        heartBurst(hearts); 
        awaitTapOnce(()=>location.href='./index.html'); 
      };
      x.onclick=(e)=>{ 
        e.preventDefault(); 
        btns.innerHTML=''; 
        updateDialog('íƒœì´', './assets/avatar_taei.png', 'ë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘');
        awaitTapOnce(()=>location.href='./index.html'); 
      };
    });
  };

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì˜ìƒ ì¢…ë£Œ ì‹œ finish ì‹¤í–‰
  v2.addEventListener('ended', finish, {once:true});
  v2.addEventListener('timeupdate', ()=>{
    if(!done && v2.duration && v2.currentTime >= v2.duration - 0.2) finish();
  });
}

// --- ì´ˆê¸° ì‹¤í–‰ ---
setupStart(vid,hint);
vid.addEventListener('ended', startScene3Dialogs, {once:true});
</script>
</body>
</html>
