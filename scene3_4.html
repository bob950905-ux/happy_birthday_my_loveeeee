<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 3+4 â€” hotfix</title>
<link rel="stylesheet" href="./assets/ui.css?v=hotfix1"/>
<style>
  .continue-chip{position:absolute;top:14vh;left:50%;transform:translateX(-50%);padding:8px 14px;border-radius:999px;background:#0f1f34e6;border:1.5px solid #071223;box-shadow:0 3px 0 #071223;display:none;z-index:25}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene3_taei.mp4?v=hotfix1" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>
  <div class="continue-chip" id="cont">íƒ­í•´ì„œ ê³„ì†</div>

  <div class="dialog" id="dialog">
    <div class="row" id="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png?v=hotfix1" alt="avatar"/>
      <div class="bubble" id="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>

  <div class="hearts" id="hearts"></div>
</div>

<script>
function awaitTapOnce(next){
  const stage=document.querySelector('.stage');
  const fn=(e)=>{ if(e.target.closest && e.target.closest('.btn')) return;
    stage.removeEventListener('click',fn); stage.removeEventListener('touchend',fn); next(); };
  stage.addEventListener('click',fn,{passive:true});
  stage.addEventListener('touchend',fn,{passive:true});
}
function setupStart(vid,hint){
  hint.style.display='block';
  const tap=document.getElementById('tap');
  const start=()=>{hint.style.display='none';vid.muted=true;vid.playsInline=true;vid.play().catch(()=>{tap.style.display='block';});};
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}
function heartBurst(container){
  container.innerHTML='';
  for(let i=0;i<10;i++){
    const s=document.createElement('span'); s.textContent='â¤';
    s.style.position='relative'; s.style.left=(Math.random()*80-40)+'px';
    s.style.animation='rise 1.5s linear forwards'; container.appendChild(s);
  }
  setTimeout(()=>container.innerHTML='',1600);
}

const vid=document.getElementById('vid');
const hint=document.getElementById('hint');
const tap=document.getElementById('tap');
const cont=document.getElementById('cont');

const dialog=document.getElementById('dialog');
const avatar=document.getElementById('avatar');
const nameEl=document.getElementById('name');
const line=document.getElementById('line');
const btns=document.getElementById('btns');
const hearts=document.getElementById('hearts');

setupStart(vid,hint);

// ---- SCENE 3 dialogs ----
function startScene3Dialogs(){
  tap.style.display='block';
  awaitTapOnce(()=>{
    tap.style.display='none'; dialog.style.display='block';
    avatar.src='./assets/avatar_seongwoo.png?v=hotfix1'; nameEl.textContent='ì„±ìš°'; line.textContent='ì–´? íƒœì´ë‹¤~~~~~';
    awaitTapOnce(()=>{
      avatar.src='./assets/avatar_taei.png?v=hotfix1'; nameEl.textContent='íƒœì´'; line.textContent='ì•„ê°€~~~~ ìƒì¼ì¶•í•˜í•´!! â¤ï¸';
      awaitTapOnce(()=>{
        line.textContent='ë‚´ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì¤„ ì„ ë¬¼ì€ ...!';
        awaitTapOnce(()=>{ dialog.style.display='none'; playScene4(); });
      });
    });
  });
}
vid.addEventListener('ended', startScene3Dialogs, {once:true});

// ---- SCENE 4 with hard watchdogs ----
function playScene4(){
  const v2=document.createElement('video');
  v2.src='./scene4_ticket.mp4?v=hotfix1';
  v2.preload='auto'; v2.playsInline=true; v2.muted=true;
  Object.assign(v2.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',background:'#000'});
  const stage=document.querySelector('.stage');
  stage.appendChild(v2);

  let finished=false, watchdog=null, absWatchdog=null;

  const finish=()=>{
    if(finished) return; finished=true;
    cont.style.display='none';
    // cleanup timers
    if(watchdog) clearTimeout(watchdog);
    if(absWatchdog) clearTimeout(absWatchdog);
    // show final dialog
    dialog.style.display='block';
    avatar.src='./assets/avatar_taei.png?v=hotfix1'; nameEl.textContent='íƒœì´';
    line.textContent='íƒœì´ë‘ ê°™ì´ ì œì£¼ë„ ê°€ì~!!! âœˆï¸';
    btns.innerHTML='';
    awaitTapOnce(()=>{
      const o=document.createElement('a'); o.className='btn'; o.textContent='íƒœì´ë‘ í•¨ê»˜í• ë˜~ ğŸ’–';
      const x=document.createElement('a'); x.className='btn'; x.textContent='ë„˜ ê°‘ì‘ìŠ¤ëŸ¬ì›Œì„œ ì•ˆê°ˆë˜ìš”! ğŸ˜­';
      btns.append(o,x);
      o.onclick=(e)=>{ e.preventDefault(); btns.innerHTML=''; line.textContent='íƒœì´í•œí…Œ ë½€ë½€~ (í•˜íŠ¸)'; heartBurst(hearts); awaitTapOnce(()=>location.href='./index.html'); };
      x.onclick=(e)=>{ e.preventDefault(); btns.innerHTML=''; line.textContent='ë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘'; awaitTapOnce(()=>location.href='./index.html'); };
    });
  };

  const armWatchdogs=()=>{
    // duration ê¸°ë°˜ ê°ì‹œíƒ€ì´ë¨¸ (duration + 800ms)
    const dur = (isFinite(v2.duration) && v2.duration>0) ? v2.duration : 10; // duration ëª»ì½ìœ¼ë©´ 10ì´ˆ ê°€ì •
    watchdog = setTimeout(()=>{
      // ë ê·¼ì²˜ë©´ ë°”ë¡œ finish, ì•„ë‹ˆë©´ ìœ ì €ì—ê²Œ 'íƒ­í•´ì„œ ê³„ì†' ë…¸ì¶œ
      if (v2.currentTime >= (v2.duration||dur) - 0.4) finish();
      else cont.style.display='block';
    }, Math.min(60000, dur*1000 + 800));
    // ì ˆëŒ€ íƒ€ì„ì•„ì›ƒ (ìµœëŒ€ 20ì´ˆ): ì–´ë–¤ ê²½ìš°ë“  ê°•ì œ ì§„í–‰
    absWatchdog = setTimeout(()=>{
      cont.style.display='block';
    }, 20000);
  };

  // ìˆ˜ë™ íƒ­ í´ë°±: ì–¸ì œë“  'íƒ­í•´ì„œ ê³„ì†'ì´ ë³´ì¼ ë•Œ íƒ­í•˜ë©´ finish
  const manualAdvance=()=>{
    if (cont.style.display==='block') finish();
  };
  stage.addEventListener('click', manualAdvance, {passive:true});
  stage.addEventListener('touchend', manualAdvance, {passive:true});

  // ì¬ìƒ ì‹œë„ + ì¤€ë¹„ ì´ë²¤íŠ¸ë“¤
  const tryPlay=()=>{ v2.play().catch(()=>{ tap.style.display='block'; }); };
  v2.addEventListener('loadedmetadata', armWatchdogs, {once:true});
  v2.addEventListener('canplaythrough', ()=>{ /* no-op; best effort */ }, {once:true});
  v2.addEventListener('ended', finish, {once:true});
  v2.addEventListener('timeupdate', ()=>{
    if(!finished && v2.duration && v2.currentTime >= v2.duration - 0.25) finish();
    // ì§„í–‰ì´ ë©ˆì¶˜ ë“¯í•˜ë©´ 'íƒ­í•´ì„œ ê³„ì†' ë„ì›€
    if(!finished && v2.currentTime>0 && v2.paused) cont.style.display='block';
  });
  v2.addEventListener('pause', ()=>{
    if(!finished && v2.duration && v2.currentTime >= (v2.duration - 0.25)) finish();
  });
  v2.addEventListener('stalled', ()=>{ cont.style.display='block'; });
  v2.addEventListener('waiting', ()=>{ /* buffer stall */ });

  tryPlay();
}
</script>
</body>
</html>

