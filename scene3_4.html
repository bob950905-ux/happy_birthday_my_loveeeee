<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 3+4 (Final Working Version - Integrated)</title>
<link rel="stylesheet" href="./assets/ui.css"/> 

<style>
/* ğŸ’– í•˜íŠ¸ ì• ë‹ˆë©”ì´ì…˜ê³¼ íƒ­ì¹© ìœ„ì¹˜/í¬ê¸° ê¸´ê¸‰ ë³µêµ¬ í¬í•¨ */
.dialog {
    display: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out;
}
.dialog.show {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    z-index: 9999 !important; 
}

@keyframes fall {
    0% { transform: translateY(-10vh) scale(1); opacity: 1; }
    100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
}
.hearts span {
    position: absolute; 
    pointer-events: none; 
}

.tapchip {
    position: absolute; 
    right: 30px; 
    left: auto;
    bottom: 25vh;
    z-index: 10000 !important;
    padding: 15px 30px;
    font-size: 1.2em;
    border-radius: 20px; 
    border: 2px solid white; 
    background-color: rgba(0, 0, 0, 0.7); 
    color: white; 
    cursor: pointer;
}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene3_taei.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>
  <div class="dialog" id="dialog">
    <div class="row" id="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble" id="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>
  <div class="hearts" id="hearts"></div>
</div>
<script>
// --- ì „ì—­ ìš”ì†Œ ì •ì˜ ---
const vid = document.getElementById('vid'); 
const hint = document.getElementById('hint'); 
const tap = document.getElementById('tap');
const dialog = document.getElementById('dialog'); 
const avatar = document.getElementById('avatar'); 
const nameEl = document.getElementById('name');
const line = document.getElementById('line'); 
const btns = document.getElementById('btns'); 
const hearts = document.getElementById('hearts');

// --- í†µí•© í•¨ìˆ˜: awaitTapOnce ---
function awaitTapOnce(next){
  tap.style.display='block'; 
  const fn=(e)=>{ 
    tap.removeEventListener('click',fn); 
    tap.removeEventListener('touchend',fn); 
    tap.style.display='none'; 
    next(); 
  };
  tap.addEventListener('click',fn,{passive:true});
  tap.addEventListener('touchend',fn,{passive:true});
}

// --- í†µí•© í•¨ìˆ˜: heartBurst ---
function heartBurst(container){
  container.innerHTML='';
  for(let i=0;i<10;i++){
    const s=document.createElement('span'); s.textContent='â¤'; 
    s.style.position='absolute'; 
    s.style.left=(Math.random()*80)+'vw'; 
    s.style.top='-50px'; 
    s.style.animation='fall 1.5s linear forwards'; 
    container.appendChild(s);
  }
  setTimeout(()=>container.innerHTML='',1600);
}

// --- í†µí•© í•¨ìˆ˜: setupStart ---
function setupStart(vid,hint){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none'; 
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=>{ tap.style.display='block'; });
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

// --- í†µí•© í•¨ìˆ˜: updateDialog ---
function updateDialog(name, avatarSrc, text, hideTapChip=false){
    dialog.classList.add('show');
    dialog.style.zIndex = '9999'; 
    avatar.src = avatarSrc;
    nameEl.textContent = name;
    line.textContent = text;
    btns.innerHTML = '';
}

function startScene3Dialogs(){
  // 1. ì„±ìš°: â€œì–´? íƒœì´ë‹¤~~~~~â€
  updateDialog('ì„±ìš°', './assets/avatar_seongwoo.png', 'ì–´? íƒœì´ë‹¤~~~~~');
  
  awaitTapOnce(()=>{
    // 2. íƒœì´: â€œì•„ê°€, ìƒì¼ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•´! ğŸ‚ ë„¤ê°€ ì´ë ‡ê²Œ í–‰ë³µí•´í•˜ëŠ” ê±° ë³´ë‹ˆê¹Œ ë‚˜ë„ ë„ˆë¬´ ì¢‹ì•„.â€
    updateDialog('íƒœì´', './assets/avatar_taei.png', 'ì•„ê°€, ìƒì¼ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•´! ğŸ‚ ë„¤ê°€ ì´ë ‡ê²Œ í–‰ë³µí•´í•˜ëŠ” ê±° ë³´ë‹ˆê¹Œ ë‚˜ë„ ë„ˆë¬´ ì¢‹ì•„.');
    
    awaitTapOnce(()=>{
      // 3. íƒœì´: â€œê·¸ë¦¬ê³ ... ë§ˆì§€ë§‰ ë‚´ ì„ ë¬¼ì€...... ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ğŸ¥â€
      updateDialog('íƒœì´', './assets/avatar_taei.png', 'ê·¸ë¦¬ê³ ... ë§ˆì§€ë§‰ ë‚´ ì„ ë¬¼ì€...... ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ğŸ¥');
      
      awaitTapOnce(()=>{
        // 4. íƒœì´: â€œë°”ë¡œ ë‚˜ì•¼!!! ğŸ’–â€
        updateDialog('íƒœì´', './assets/avatar_taei.png', 'ë°”ë¡œ ë‚˜ì•¼!!! ğŸ’–');

        awaitTapOnce(()=>{
          // 5. "íˆíˆ ë‚˜ë„ ì„ ë¬¼ì´ê³ ! ì§„ì§œ ë§ˆì§€ë§‰ ì„ ë¬¼ì€.....!"
          updateDialog('íƒœì´', './assets/avatar_taei.png', 'íˆíˆ ë‚˜ë„ ì„ ë¬¼ì´ê³ ! ì§„ì§œ ë§ˆì§€ë§‰ ì„ ë¬¼ì€.....!');

          awaitTapOnce(()=>{
            // 6. ì”¬4 ì˜ìƒ ì¬ìƒ ì‹œì‘
            dialog.classList.remove('show');
            playScene4(); 
          });
        });
      });
    });
  });
}

// --- Scene 4 ë¡œì§ ---
let v2 = null; 

function playScene4(){
  tap.style.display='none'; 

  v2=document.createElement('video');
  v2.src='./scene4_ticket.mp4';
  v2.playsInline=true; v2.muted=true; v2.preload='auto';
  Object.assign(v2.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',background:'#000'});
  document.querySelector('.stage').appendChild(v2);

  if (vid.parentNode) vid.parentNode.removeChild(vid); 

  v2.play().catch(()=>{ tap.style.display='block'; });

  let done=false;
  const finish=()=>{
    if(done) return; done=true;

    // 1. ğŸ–¼ï¸ ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì •: HTML <img> íƒœê·¸ ì‚¬ìš©
    const lastFrameUrl = v2.src.replace('.mp4', '.png') + '?v=2025110706'; 
    
    const imgElement = document.createElement('img');
    imgElement.src = lastFrameUrl;
    imgElement.id = 'scene4_bg';
    Object.assign(imgElement.style, {
        position: 'absolute',
        inset: '0',
        width: '100vw',
        height: '100vh',
        objectFit: 'contain',
        zIndex: '1' 
    });
    
    const stageEl = document.querySelector('.stage');
    
    imgElement.onload = () => {
        if (v2.parentNode) {
            v2.parentNode.removeChild(v2); 
            v2 = null; 
        }
        stageEl.appendChild(imgElement); 

        // 7. íƒœì´: â€œìš°ë¦¬ ê°™ì´ ë– ë‚˜ì, ìê¸°ì•¼! âœˆï¸â€ (ìë™ ë…¸ì¶œ)
        updateDialog('íƒœì´', './assets/avatar_taei.png', 'ìš°ë¦¬ ê°™ì´ ë– ë‚˜ì, ìê¸°ì•¼! âœˆï¸');
        btns.innerHTML='';

        // 8. íƒ­ì„ ê¸°ë‹¤ë ¤ ì„±ìš°ì˜ ê°ë™ ëŒ€ì‚¬
        awaitTapOnce(()=>{ 
            // ì„±ìš°: â€œí—... ì™„ì „ ê°ë™ì´ì•¼. ë‚´ ë§ˆìŒì€ ì´ë¯¸ ì¶œë°œí–ˆëŠ”ë°?â€
            updateDialog('ì„±ìš°', './assets/avatar_seongwoo.png', 'í—... ì™„ì „ ê°ë™ì´ì•¼. ë‚´ ë§ˆìŒì€ ì´ë¯¸ ì¶œë°œí–ˆëŠ”ë°?');
            
            // 9. íƒ­ì„ ê¸°ë‹¤ë ¤ ì„ íƒì§€ ë²„íŠ¼ í‘œì‹œ
            awaitTapOnce(()=>{
                 tap.style.display = 'none'; // ë²„íŠ¼ì´ ë‚˜íƒ€ë‚˜ë©´ íƒ­ì¹© ìˆ¨ê¹€
                 
                 const o=document.createElement('a'); o.className='btn'; o.textContent='ê³ ë¯¼ì€ ë¬´ìŠ¨! ë‹¹ì¥ íƒœì´ ì† ì¡ê³  ë– ë‚ ë˜~ ğŸ’–';
                 const x=document.createElement('a'); x.className='btn'; x.textContent='ì ê¹! ë„ˆë¬´ ê°‘ì‘ìŠ¤ëŸ¬ì›Œ... ë‹¤ìŒì— ê°ˆë˜ìš”! ğŸ˜­';
                 btns.append(o,x);

                 // ğŸ’– ë²„íŠ¼ 1 (ì„ íƒ ì‹œ)
                 o.onclick=(e)=>{ 
                     e.preventDefault(); 
                     btns.innerHTML=''; 
                     // 9. íƒœì´: â€œíƒœì´í•œí…Œ ë½€ë½€~ğŸ’‹ ì™„ë²½í•œ ì„ íƒ! ìš°ë¦¬ ê°€ì„œ ë§›ìˆëŠ” ê±° ì”ëœ© ë¨¹ê³  ì˜¤ì~!â€
                     updateDialog('íƒœì´', './assets/avatar_taei.png', 'íƒœì´í•œí…Œ ë½€ë½€~ğŸ’‹ ì™„ë²½í•œ ì„ íƒ! ìš°ë¦¬ ê°€ì„œ ë§›ìˆëŠ” ê±° ì”ëœ© ë¨¹ê³  ì˜¤ì~!');
                     heartBurst(hearts); 
                     
                     // 10. ë©”ì¸ í™”ë©´ ë²„íŠ¼ í‘œì‹œ
                     awaitTapOnce(()=>{
                         tap.style.display = 'none';
                         const home=document.createElement('a');
                         home.href='./index.html';
                         home.className='btn';
                         home.textContent='ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
                         btns.appendChild(home);
                     });
                 };
                 // ğŸ˜­ ë²„íŠ¼ 2 (ì„ íƒ ì‹œ)
                 x.onclick=(e)=>{ 
                     e.preventDefault(); 
                     btns.innerHTML=''; 
                     // 9. íƒœì´: â€œë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘ ğŸ¥º ë‹¤ìŒì—” ê¼­ ê°™ì´ ê°€ì~ ì•½ì†ì´ì•¼!â€
                     updateDialog('íƒœì´', './assets/avatar_taei.png', 'ë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘ ğŸ¥º ë‹¤ìŒì—” ê¼­ ê°™ì´ ê°€ì~ ì•½ì†ì´ì•¼!');
                     
                     // 10. ë©”ì¸ í™”ë©´ ë²„íŠ¼ í‘œì‹œ
                     awaitTapOnce(()=>{
                         tap.style.display = 'none';
                         const home=document.createElement('a');
                         home.href='./index.html';
                         home.className='btn';
                         home.textContent='ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
                         btns.appendChild(home);
                     });
                 };
            });
        });
    };

    imgElement.onerror = imgElement.onload; 
    imgElement.src = lastFrameUrl; 
  };

  v2.addEventListener('ended', finish, {once:true});
  v2.addEventListener('timeupdate', ()=>{
    if(!done && v2.duration && v2.currentTime >= v2.duration - 0.2) finish();
  });
}

// --- ì´ˆê¸° ì‹¤í–‰ ---
setupStart(vid,hint);
vid.addEventListener('ended', startScene3Dialogs, {once:true});
</script>
</body>
</html>
