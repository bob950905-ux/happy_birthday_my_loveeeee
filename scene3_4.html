<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 3+4 (Final Stable - TapChip Only)</title>
<link rel="stylesheet" href="./assets/ui.css"/>

<style>
  .dialog{ display:none; opacity:0; visibility:hidden; transition:opacity .25s ease; }
  .dialog.show{ display:block!important; opacity:1!important; visibility:visible!important; z-index:9999!important; }

  /* í•˜íŠ¸ ì´í™íŠ¸ */
  @keyframes fall{ 0%{transform:translateY(-10vh) scale(1);opacity:1;}
                   100%{transform:translateY(100vh) scale(.5);opacity:0;} }
  .hearts span{ position:absolute; pointer-events:none; }

  /* íƒ­ì¹©: ëŒ€í™”ì°½ ìœ„ë¡œ ë‚´ë¦¬ê³  ëˆŒë¦¬ê¸° í¸í•˜ê²Œ í‚¤ì›€ */
  .tapchip{
    position: fixed;
    left: 50%;
    bottom: 110px;              /* í•„ìš”ì‹œ 90~130pxë¡œ ì¡°ì ˆ */
    transform: translateX(-50%);
    display: none;
    padding: 12px 18px;
    border-radius: 999px;
    background: rgba(20,28,38,.9);
    color:#fff; font-weight:700; font-size:1rem;
    border:1px solid rgba(255,255,255,.15);
    box-shadow:0 4px 18px rgba(0,0,0,.35);
    user-select:none; -webkit-user-select:none;
    transition: bottom .2s ease;
    z-index: 10000;
  }
  .tapchip:active{ transform: translateX(-50%) scale(.96); }
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene3_taei.mp4" preload="auto" playsinline webkit-playsinline muted></video>

  <!-- ì‹œì‘ ë²„íŠ¼ -->
  <div class="hint" id="hint">ğŸ¬ START!</div>

  <!-- íƒ­ì¹©: ì´ ë²„íŠ¼ë§Œ ëˆŒë ¤ì•¼ ì§„í–‰ë¨ -->
  <div class="tapchip" id="tap">íƒ­!</div>

  <!-- ëŒ€í™”ì°½ -->
  <div class="dialog" id="dialog">
    <div class="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>

  <div class="hearts" id="hearts"></div>
</div>

<script>
/* ---------- ìš”ì†Œ ---------- */
const stage  = document.querySelector('.stage');
const vid    = document.getElementById('vid');
const hint   = document.getElementById('hint');
const tapEl  = document.getElementById('tap');
const dialog = document.getElementById('dialog');
const avatar = document.getElementById('avatar');
const nameEl = document.getElementById('name');
const lineEl = document.getElementById('line');
const btns   = document.getElementById('btns');
const hearts = document.getElementById('hearts');

/* ========== TAPì¹© ì „ìš© ì§„í–‰ ìœ í‹¸ ========== */
let tapAction=null, tapGuard=false;
function setTap(next, label='íƒ­!'){
  tapAction = next;
  tapEl.textContent = label;
  tapEl.style.display = 'inline-flex';
}
function clearTap(){
  tapAction = null;
  tapEl.style.display = 'none';
}
function onTap(e){
  if(e.target!==tapEl) return;            // ì¹©ë§Œ í—ˆìš©
  e.preventDefault(); e.stopPropagation();
  if(tapGuard) return;
  tapGuard=true; setTimeout(()=>tapGuard=false, 220);  // iOS touchendâ†’click ì´ì¤‘ë°œí™” ë°©ì§€
  const fn = tapAction; clearTap();
  if(typeof fn==='function') fn();
}
tapEl.addEventListener('touchend', onTap, {passive:false});
tapEl.addEventListener('click',    onTap, {passive:false});
/* ë¬¸ì„œ ì „ì—­ í´ë¦­ ì§„í–‰ ì°¨ë‹¨(ì˜ˆì „ ì „ì—­ í•¸ë“¤ëŸ¬ ë¬´ë ¥í™”) */
window.addEventListener('click', (e)=>{ if(e.target!==tapEl) e.stopPropagation(); }, {capture:true});

/* ========== START & ì¬ìƒ ========== */
function setupStart(video, startHint){
  startHint.style.display='none';
  video.addEventListener('canplay', ()=>{ startHint.style.display='block'; }, {once:true});
  const begin=()=>{
    startHint.style.display='none';
    video.muted=true; video.playsInline=true;
    video.play().catch(()=>{ setTap(()=>video.play(),'íƒ­!'); }); // ì¸ì•±/ì‚¬íŒŒë¦¬ ì¬ìƒí™€ë”© ìš°íšŒ
  };
  ['pointerdown','touchend','click'].forEach(ev=>{
    document.addEventListener(ev, begin, {once:true, passive:true});
  });
}

/* ========== ëŒ€í™”ì°½ ========== */
function showDialog(text, who='ì„±ìš°', avatarSrc='./assets/avatar_seongwoo.png'){
  dialog.classList.add('show');
  avatar.src = avatarSrc;
  nameEl.textContent = who;
  lineEl.textContent = text;
  btns.innerHTML = '';
}

/* ========== í•˜íŠ¸ ì´í™íŠ¸ ========== */
function heartBurst(container){
  container.innerHTML='';
  for(let i=0;i<12;i++){
    const s=document.createElement('span');
    s.textContent='â¤';
    s.style.left=(Math.random()*80)+'vw';
    s.style.top='-40px';
    s.style.animation='fall 1.5s linear forwards';
    container.appendChild(s);
  }
  setTimeout(()=>container.innerHTML='',1600);
}

/* ---------- Scene 3 ëŒ€ì‚¬ íë¦„ ---------- */
function startScene3Dialogs(){
  showDialog('ì–´? íƒœì´ë‹¤~~~~~','ì„±ìš°','./assets/avatar_seongwoo.png');
  setTap(()=>{
    showDialog('ì•„ê°€, ìƒì¼ ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•´! ğŸ‚ ë„¤ê°€ ì´ë ‡ê²Œ í–‰ë³µí•´í•˜ëŠ” ê±° ë³´ë‹ˆê¹Œ ë‚˜ë„ ë„ˆë¬´ ì¢‹ì•„.','íƒœì´','./assets/avatar_taei.png');
    setTap(()=>{
      showDialog('ê·¸ë¦¬ê³ ... ë§ˆì§€ë§‰ ë‚´ ì„ ë¬¼ì€...... ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ë‘êµ¬ğŸ¥','íƒœì´','./assets/avatar_taei.png');
      setTap(()=>{
        showDialog('ë°”ë¡œ ë‚˜ì•¼!!! ğŸ’–','íƒœì´','./assets/avatar_taei.png');
        setTap(()=>{
          showDialog('ã…‹ã…‹ã…‹ã…‹ ì¥ë‚œì´ê³ ! ì§„ì§œ ë§ˆì§€ë§‰ ì„ ë¬¼ì€.....!','íƒœì´','./assets/avatar_taei.png');
          setTap(()=>{
            dialog.classList.remove('show');
            playScene4();  // ì”¬4 ì‹œì‘
          });
        });
      });
    });
  });
}

/* ---------- Scene 4 ---------- */
let v2=null;
function playScene4(){
  clearTap();
  // ë¹„ë””ì˜¤2 ìƒì„±
  v2=document.createElement('video');
  v2.src='./scene4_ticket.mp4';
  v2.playsInline=true; v2.muted=true; v2.preload='auto';
  Object.assign(v2.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',background:'#000',zIndex:1});
  stage.appendChild(v2);
  // ê¸°ì¡´ vid ì œê±°
  if(vid.parentNode) vid.parentNode.removeChild(vid);

  const finish=()=>{
    // ì•ˆì „ê°€ë“œ
    if(!v2) return;
    // ë§ˆì§€ë§‰ í”„ë ˆì„ ëŒ€ì²´ ì´ë¯¸ì§€(ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê±´ë„ˆëœ€)
    const bg = document.createElement('img');
    bg.src = v2.src.replace('.mp4','.png') + '?v=20251110';
    Object.assign(bg.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',zIndex:1,background:'#000'});

    const onReady = ()=>{
      if(v2 && v2.parentNode) v2.parentNode.removeChild(v2);
      v2=null;
      stage.appendChild(bg);

      // ì”¬4 ì¢…ë£Œ ì§í›„ ëŒ€ì‚¬ ìë™ ë…¸ì¶œ
      showDialog('ìš°ë¦¬ ê°™ì´ ë– ë‚˜ì, ìê¸°ì•¼! âœˆï¸','íƒœì´','./assets/avatar_taei.png');

      // ì„±ìš° ê°ë™ â†’ ì„ íƒì§€
      setTap(()=>{
        showDialog('í—... ì™„ì „ ê°ë™ì´ì•¼. ë‚´ ë§ˆìŒì€ ì´ë¯¸ ì¶œë°œí–ˆëŠ”ë°?','ì„±ìš°','./assets/avatar_seongwoo.png');
        setTap(()=>{
          btns.innerHTML='';
          const o=document.createElement('a'); o.className='btn'; o.textContent='ê³ ë¯¼ì€ ë¬´ìŠ¨! ë‹¹ì¥ íƒœì´ ì† ì¡ê³  ë– ë‚ ë˜~ ğŸ’–';
          const x=document.createElement('a'); x.className='btn'; x.textContent='ì ê¹! ë„ˆë¬´ ê°‘ì‘ìŠ¤ëŸ¬ì›Œ... ë‹¤ìŒì— ê°ˆë˜ìš”! ğŸ˜­';
          btns.append(o,x);

          // ì„ íƒ í•¸ë“¤ëŸ¬
          function decide(goHappy){
            btns.innerHTML='';
            if(goHappy){
              showDialog('íƒœì´í•œí…Œ ë½€ë½€~ğŸ’‹ ì™„ë²½í•œ ì„ íƒ! ìš°ë¦¬ ê°€ì„œ ë§›ìˆëŠ” ê±° ì”ëœ© ë¨¹ê³  ì˜¤ì~!','íƒœì´','./assets/avatar_taei.png');
              heartBurst(hearts);
            }else{
              showDialog('ë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘ ğŸ¥º ë‹¤ìŒì—” ê¼­ ê°™ì´ ê°€ì~ ì•½ì†ì´ì•¼!','íƒœì´','./assets/avatar_taei.png');
            }
            setTap(()=>{
              btns.innerHTML='';
              const home=document.createElement('a');
              home.href='./index.html';
              home.className='btn';
              home.textContent='ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
              btns.appendChild(home);
            });
          }
          o.addEventListener('click',(e)=>{e.preventDefault();decide(true);},{once:true});
          x.addEventListener('click',(e)=>{e.preventDefault();decide(false);},{once:true});
        });
      });
    };
    bg.onload = onReady;
    bg.onerror = onReady; // PNG ì—†ìœ¼ë©´ ë°”ë¡œ ì§„í–‰

    // ë¡œë“œ íŠ¸ë¦¬ê±°
    bg.src = bg.src;
  };

  // ì¬ìƒ & ì¢…ë£Œ ê°ì‹œ
  const tryPlay=()=>{ v2.play().catch(()=>{ setTap(()=>v2.play(),'íƒ­!'); }); };
  v2.addEventListener('ended', finish, {once:true});
  v2.addEventListener('timeupdate', ()=>{ 
    if(v2.duration && v2.currentTime >= v2.duration-0.2) finish();
  });
  tryPlay();
}

/* ---------- ë¶€íŠ¸ ---------- */
setupStart(vid, hint);
vid.addEventListener('ended', startScene3Dialogs, {once:true});
</script>
</body>
</html>
