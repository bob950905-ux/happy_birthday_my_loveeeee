<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 3+4 (Final Working Version - Stable)</title>
<link rel="stylesheet" href="./assets/ui.css"/> 

<style>
/* --- í•„ìˆ˜ ìŠ¤íƒ€ì¼ (CSS ì¶©ëŒ ë°©ì§€ ë° ì• ë‹ˆë©”ì´ì…˜) --- */
.dialog {
    display: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out;
}
.dialog.show {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
    z-index: 9999 !important; 
}

/* ğŸ’– í•˜íŠ¸ê°€ ìœ„ì—ì„œ ì•„ë˜ë¡œ ë–¨ì–´ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
@keyframes fall {
    0% { transform: translateY(-10vh) scale(1); opacity: 1; }
    100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
}
.hearts span {
    position: absolute; 
    pointer-events: none; 
}

/* ğŸš¨ íƒ­ì¹© ìœ„ì¹˜ ìˆ˜ì •: í™”ë©´ í•˜ë‹¨ ëŒ€í™”ì°½ ê·¼ì²˜ë¡œ ë‚´ë¦¼ */
.tapchip {
    position: absolute; 
    bottom: 25vh; /* ëŒ€í™”ì°½ ìœ„ë¡œ ë‚´ë¦° ìœ„ì¹˜ */
    z-index: 10000 !important; 
}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene3_taei.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>
  <div class="dialog" id="dialog">
    <div class="row" id="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble" id="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>
  <div class="hearts" id="hearts"></div>
</div>
<script>
// --- ì „ì—­ ìš”ì†Œ ì •ì˜ ---
const vid = document.getElementById('vid'); 
const hint = document.getElementById('hint'); 
const tap = document.getElementById('tap');
const dialog = document.getElementById('dialog'); 
const avatar = document.getElementById('avatar'); 
const nameEl = document.getElementById('name');
const line = document.getElementById('line'); 
const btns = document.getElementById('btns'); 
const hearts = document.getElementById('hearts');

// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

/** ğŸš¨ íƒ­ì¹© ì „ìš© íƒ­ í•¨ìˆ˜: tapchipì„ ëˆŒëŸ¬ì•¼ë§Œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤. */
function awaitTapOnce(next){
  tap.style.display='block'; 
  
  const fn=(e)=>{ 
    tap.removeEventListener('click',fn); 
    tap.removeEventListener('touchend',fn); 
    tap.style.display='none'; 
    next(); 
  };
  
  tap.addEventListener('click',fn,{passive:true});
  tap.addEventListener('touchend',fn,{passive:true});
}

function heartBurst(container){
  container.innerHTML='';
  for(let i=0;i<10;i++){
    const s=document.createElement('span'); s.textContent='â¤'; 
    s.style.position='absolute'; 
    s.style.left=(Math.random()*80)+'vw'; 
    s.style.top='-50px'; 
    s.style.animation='fall 1.5s linear forwards'; 
    container.appendChild(s);
  }
  setTimeout(()=>container.innerHTML='',1600);
}

function setupStart(vid,hint){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none'; 
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=>{ tap.style.display='block'; });
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

function updateDialog(name, avatarSrc, text, hideTapChip=false){
    dialog.classList.add('show');
    dialog.style.zIndex = '9999'; 
    avatar.src = avatarSrc;
    nameEl.textContent = name;
    line.textContent = text;
    btns.innerHTML = '';
}

function startScene3Dialogs(){
  updateDialog('ì„±ìš°', './assets/avatar_seongwoo.png', 'ì–´? íƒœì´ë‹¤~~~~~');
  
  awaitTapOnce(()=>{
    updateDialog('íƒœì´', './assets/avatar_taei.png', 'ì•„ê°€~~~~ ìƒì¼ì¶•í•˜í•´!! â¤ï¸');
    awaitTapOnce(()=>{
      line.textContent = 'ë‚´ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì¤„ ì„ ë¬¼ì€ ...!';
      awaitTapOnce(()=>{ 
        dialog.classList.remove('show');
        playScene4(); 
      });
    });
  });
}

// --- Scene 4 ë¡œì§ ---
let v2 = null; 

function playScene4(){
  tap.style.display='none'; 

  v2=document.createElement('video');
  v2.src='./scene4_ticket.mp4';
  v2.playsInline=true; v2.muted=true; v2.preload='auto';
  Object.assign(v2.style,{position:'absolute',inset:'0',width:'100vw',height:'100vh',objectFit:'contain',background:'#000'});
  document.querySelector('.stage').appendChild(v2);

  if (vid.parentNode) vid.parentNode.removeChild(vid); 

  v2.play().catch(()=>{ tap.style.display='block'; });

  let done=false;
  const finish=()=>{
    if(done) return; done=true;

    // 1. ğŸ–¼ï¸ ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì •: HTML <img> íƒœê·¸ ì‚¬ìš©
    const lastFrameUrl = v2.src.replace('.mp4', '.png') + '?v=2025110706'; // ë²„ì „ ë²ˆí˜¸ ë³€ê²½
    
    const imgElement = document.createElement('img');
    imgElement.src = lastFrameUrl;
    imgElement.id = 'scene4_bg';
    Object.assign(imgElement.style, {
        position: 'absolute',
        inset: '0',
        width: '100vw',
        height: '100vh',
        objectFit: 'contain',
        zIndex: '1' 
    });
    
    const stageEl = document.querySelector('.stage');
    
    // 2. ì´ë¯¸ì§€ ë¡œë”© ì™„ë£Œ í›„ ë‹¤ìŒ ë¡œì§ ì‹¤í–‰
    imgElement.onload = () => {
        if (v2.parentNode) {
            v2.parentNode.removeChild(v2); 
            v2 = null; 
        }
        stageEl.appendChild(imgElement); 

        // 1. íƒœì´ì˜ ì§ˆë¬¸ í‘œì‹œ
        updateDialog('íƒœì´', './assets/avatar_taei.png', 'íƒœì´ë‘ ê°™ì´ ì œì£¼ë„ ê°€ì~!!! âœˆï¸');
        btns.innerHTML='';

        // 2. íƒ­ì„ ê¸°ë‹¤ë ¤ ì„±ìš°ì˜ ìƒê°ê³¼ ì„ íƒì§€ ë²„íŠ¼ì„ í‘œì‹œ
        awaitTapOnce(()=>{ 
            // í™”ìë¥¼ ì„±ìš°ë¡œ ë³€ê²½í•˜ê³  ì„±ìš°ì˜ ìƒê° ëŒ€ì‚¬ë¥¼ ë„£ìŠµë‹ˆë‹¤.
            avatar.src = './assets/avatar_seongwoo.png';
            nameEl.textContent = 'ì„±ìš°';
            line.textContent = 'ë‚´ ë§ˆìŒì€... ì–´ë–¤ê±¸ ì„ íƒí•´ì•¼ í• ê¹Œ?'; 
            
            // ì„ íƒì§€ ë²„íŠ¼ ìƒì„±
            const o=document.createElement('a'); o.className='btn'; o.textContent='íƒœì´ë‘ í•¨ê»˜í• ë˜~ ğŸ’–';
            const x=document.createElement('a'); x.className='btn'; x.textContent='ë„˜ ê°‘ì‘ìŠ¤ëŸ¬ì›Œì„œ ì•ˆê°ˆë˜ìš”! ğŸ˜­';
            btns.append(o,x);
            tap.style.display = 'none'; // ë²„íŠ¼ì´ ë‚˜íƒ€ë‚˜ë©´ íƒ­ì¹©ì„ ìˆ¨ê¹€
            
            // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            o.onclick=(e)=>{ 
                e.preventDefault(); 
                btns.innerHTML=''; 
                updateDialog('íƒœì´', './assets/avatar_taei.png', 'íƒœì´í•œí…Œ ë½€ë½€~ (í•˜íŠ¸)');
                heartBurst(hearts); 
                awaitTapOnce(()=>location.href='./index.html'); 
            };
            x.onclick=(e)=>{ 
                e.preventDefault(); 
                btns.innerHTML=''; 
                updateDialog('íƒœì´', './assets/avatar_taei.png', 'ë„ˆë¬´ ìŠ¬í¬ìš” í‘í‘');
                awaitTapOnce(()=>location.href='./index.html'); 
            };
        });
    };

    imgElement.onerror = imgElement.onload; 
    imgElement.src = lastFrameUrl; 
  };

  v2.addEventListener('ended', finish, {once:true});
  v2.addEventListener('timeupdate', ()=>{
    if(!done && v2.duration && v2.currentTime >= v2.duration - 0.2) finish();
  });
}

// --- ì´ˆê¸° ì‹¤í–‰ ---
setupStart(vid,hint);
vid.addEventListener('ended', startScene3Dialogs, {once:true});
</script>
</body>
</html>
