<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 1 (Final Stable - Integrated)</title>
<link rel="stylesheet" href="./assets/ui.css"/>

<style>
/* CSS ì¶©ëŒ ë°©ì§€: ëŒ€í™”ì°½ì´ í™•ì‹¤íˆ ë³´ì´ë„ë¡ ë³´ì¥ */
.dialog { display: none; } 
.dialog.show { 
    display: block !important; 
    z-index: 9999; 
}
/* íƒ­ì¹© ê´€ë ¨ CSS ì‚­ì œ: ui.css ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒì•„ê° */
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene1_walk.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>
  <div class="dialog" id="dialog">
    <div class="row" id="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble" id="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>
  <div class="hearts" id="hearts"></div>
</div>
<script>
const vid=document.getElementById('vid');
const hint=document.getElementById('hint');
const tap=document.getElementById('tap');
const dialog=document.getElementById('dialog');
const avatar=document.getElementById('avatar');
const nameEl=document.getElementById('name');
const line=document.getElementById('line');
const btns=document.getElementById('btns');
const hearts=document.getElementById('hearts');

// --- í†µí•© í•¨ìˆ˜: awaitTapOnce (íƒ­ì¹© ì „ìš©) ---
function awaitTapOnce(next){
  tap.style.display='block'; 
  const fn=(e)=>{ 
    tap.removeEventListener('click',fn); 
    tap.removeEventListener('touchend',fn); 
    tap.style.display = 'none'; 
    next(); 
  };
  tap.addEventListener('click',fn,{passive:true});
  tap.addEventListener('touchend',fn,{passive:true});
}

// --- í†µí•© í•¨ìˆ˜: setupStart ---
function setupStart(vid,hint){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none'; 
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=>{ tap.style.display='block'; });
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

// --- í†µí•© í•¨ìˆ˜: showDialog ---
function showDialog(text, avatarSrc='./assets/avatar_seongwoo.png', name='ì„±ìš°') {
    dialog.classList.add('show');
    avatar.src = avatarSrc;
    nameEl.textContent = name;
    line.textContent = text;
    btns.innerHTML = '';
    tap.style.display = 'block';
}

// --- ì´ˆê¸° ì‹¤í–‰ ---
setupStart(vid, hint);

vid.addEventListener('ended', ()=>{
    tap.style.display = 'block'; 
    
    // 1. "ì–´? ê½ƒì´ë„¤."
    awaitTapOnce(()=>{
        showDialog('ì–´? ê½ƒì´ë„¤.');
        
        // 2. "ê²¨ìš¸ì— ë¬´ìŠ¨ ê½ƒì´ ë‹¤ í”¼ì—ˆëŒ€."
        awaitTapOnce(()=>{
            showDialog('ê²¨ìš¸ì— ë¬´ìŠ¨ ê½ƒì´ ë‹¤ í”¼ì—ˆëŒ€.');
            
            // 3. "ê·¸ë˜ë„... ì˜ˆì˜ë‹¤."
            awaitTapOnce(()=>{
                showDialog('ê·¸ë˜ë„... ì˜ˆì˜ë‹¤.');
                
                // 4. ë²„íŠ¼ í‘œì‹œ
                tap.style.display = 'none';
                const home=document.createElement('a');
                home.href='./index.html';
                home.className='btn';
                home.textContent='ë‹¤ìŒ ì„ ë¬¼ ê³ ë¥´ëŸ¬ ê°€ê¸° ğŸ';
                btns.appendChild(home);
            });
        });
    });
}, {once:true});
</script>
</body>
</html>
