<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 1 (Dialog Always On Top)</title>
<style>
:root { color-scheme: dark; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html,body { margin:0; background:#000; overflow:hidden; font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; }

/* ì»¨í…Œì´ë„ˆ */
.stage { position:fixed; inset:0; /* z-index ì£¼ì§€ ì•ŠìŒ */ }

/* âœ… ë¹„ë””ì˜¤ëŠ” í•­ìƒ ë§¨ ë’¤ */
video {
  position:absolute; inset:0; width:100vw; height:100vh;
  object-fit:contain; background:#000;
  z-index:0 !important;           /* ë§¨ë’¤ ê³ ì • */
  will-change: transform;
}

/* START ë²„íŠ¼ */
#hint{
  position:fixed; left:50%; top:18px; transform:translateX(-50%);
  padding:10px 14px; border-radius:999px;
  background:rgba(20,28,38,.9); color:#fff; font-weight:800;
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);
  z-index:10001;
  user-select:none;
}

/* âœ… íƒ­ì¹©: ì”¬2 ê¸°ì¤€ í†µì¼(ëŒ€ì‚¬ì°½ ìœ„) */
.tapchip{
  position:fixed !important;
  left:50%; bottom:110px; transform:translateX(-50%);
  display:none; padding:15px 30px; border-radius:999px;
  background:rgba(20,28,38,.9); color:#fff; font-weight:800; font-size:1.2rem;
  border:1px solid rgba(255,255,255,.15); box-shadow:0 4px 18px rgba(0,0,0,.35);
  width:auto !important; height:auto !important; white-space:nowrap;
  z-index:10060 !important; /* ëŒ€ì‚¬ì°½(999999)ë³´ë‹¤ ë‚®ì§€ë§Œ, ì¶©ë¶„íˆ ìœ„ì— ë³´ì„ */
}
.tapchip:active{ transform:translateX(-50%) scale(.96); }

/* âœ… ëŒ€í™”ì°½: ë¹„ë””ì˜¤ ìœ„ë¡œ ê°•ì œ */
.dialog{
  position:fixed; left:0; right:0; bottom:28px;
  display:none;
  z-index:999999 !important;      /* ìµœìƒë‹¨ */
  transform:translateZ(0);        /* iOS Safari ìŠ¤íƒœí‚¹ ì»¨í…ìŠ¤íŠ¸ ë³´ì • */
  pointer-events:auto;
}
.dialog.show{ display:block !important; }

/* ë§í’ì„  ë ˆì´ì•„ì›ƒ */
.row{ display:flex; align-items:flex-end; gap:12px; padding:0 18px; }
.avatar{ width:58px; height:58px; border-radius:10px; object-fit:cover; }
.bubble{
  flex:1; background:rgba(19,25,36,.92); border:1px solid rgba(255,255,255,.12);
  border-radius:14px; padding:14px; color:#eaf1ff; box-shadow:0 6px 22px rgba(0,0,0,.35);
}
.name{ font-weight:800; margin-bottom:6px; }
.line{ font-weight:700; font-size:1.05rem; line-height:1.55; }
.center{ margin-top:12px; }
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  padding:11px 14px; border-radius:12px; font-weight:800; font-size:.98rem;
  background:#30435f; color:#fff; border:1px solid rgba(255,255,255,.12);
  text-decoration:none; min-width:180px;
}
.btn:active{ transform:translateY(1px); }
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene1_walk.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div id="hint">ğŸ¬ START!</div>
  <div id="tap" class="tapchip">íƒ­!</div>

  <div id="dialog" class="dialog">
    <div class="row">
      <img id="avatar" class="avatar" src="./assets/avatar_seongwoo.png" alt="avatar">
      <div class="bubble">
        <div id="name" class="name">ì„±ìš°</div>
        <div id="line" class="line"></div>
        <div id="btns" class="center"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ìš”ì†Œ */
const vid   = document.getElementById('vid');
const hint  = document.getElementById('hint');
const tap   = document.getElementById('tap');
const dialog= document.getElementById('dialog');
const avatar= document.getElementById('avatar');
const nameEl= document.getElementById('name');
const line  = document.getElementById('line');
const btns  = document.getElementById('btns');

/* íƒ­ì¹© */
let tapAction=null, tapGuard=false;
function setTap(next){ tapAction=next; tap.style.display='inline-flex'; }
function clearTap(){ tapAction=null; tap.style.display='none'; }
function fireTap(){
  if(tapGuard) return;
  tapGuard=true; setTimeout(()=>tapGuard=false,150);
  const fn=tapAction; clearTap(); if(typeof fn==='function') fn();
}
tap.addEventListener('click', fireTap);
tap.addEventListener('touchend', e=>{ e.preventDefault(); fireTap(); });

/* START */
function setupStart(){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none';
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=> setTap(()=> vid.play() ));
    ['click','touchend','pointerdown'].forEach(ev=>document.removeEventListener(ev,start));
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

/* ëŒ€ì‚¬ */
function showDialog(text, who='ì„±ìš°', face='./assets/avatar_seongwoo.png'){
  dialog.classList.add('show');           // âœ… ìµœìƒë‹¨ ë ˆì´ì–´
  avatar.src = face;
  nameEl.textContent = who;
  line.textContent = text;
  btns.innerHTML = '';
}

/* ì¢…ë£Œ ì²˜ë¦¬(ëŒ€ì‚¬ ì²´ì¸) */
let endHandled = false;
function onVideoEnd(){
  if(endHandled) return;
  endHandled = true;

  // 1
  showDialog('ì–´? ê½ƒì´ë„¤.');
  setTap(()=> {
    // 2
    showDialog('ê²¨ìš¸ì— ë¬´ìŠ¨ ê½ƒì´ ë‹¤ í”¼ì—ˆëŒ€.');
    setTap(()=> {
      // 3
      showDialog('ê·¸ë˜ë„... ì˜ˆì˜ë‹¤.');
      setTap(()=> {
        clearTap();
        const home=document.createElement('a');
        home.href='./index.html';
        home.className='btn';
        home.textContent='ë‹¤ìŒ ì„ ë¬¼ ê³ ë¥´ëŸ¬ ê°€ê¸° ğŸ';
        btns.appendChild(home);
      });
    });
  });
}

/* ì‹¤í–‰ */
setupStart();

/* 1) í‘œì¤€ ended */
vid.addEventListener('ended', onVideoEnd, { once:true });

/* 2) endedê°€ ì•ˆì˜¤ëŠ” ê²½ìš° ëŒ€ë¹„: duration ê¸°ë°˜ í´ë§ */
let poll=null;
function startPoll(){
  if(poll) return;
  poll = setInterval(()=>{
    const d=vid.duration;
    if(isFinite(d) && d>0 && vid.currentTime >= d-0.15) onVideoEnd();
    if(vid.ended) onVideoEnd();
  }, 120);
}
vid.addEventListener('loadedmetadata', startPoll, { once:true });
vid.addEventListener('playing', startPoll, { once:true });

/* 3) ìµœí›„ìˆ˜ë‹¨: í•˜ë“œ íƒ€ì„ì•„ì›ƒ */
let hardTimeout = setTimeout(()=> onVideoEnd(), 20000);
vid.addEventListener('loadedmetadata', ()=>{
  if(isFinite(vid.duration) && vid.duration>0){
    clearTimeout(hardTimeout);
    hardTimeout = setTimeout(()=> onVideoEnd(), Math.ceil(vid.duration*1000)+1500);
  }
},{ once:true });

/* 4) íƒ­/ë³µê·€ì‹œ ë§‰í”„ë ˆì„ ê·¼ì ‘í•˜ë©´ ì¦‰ì‹œ ëŒ€ì‚¬ */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible'){
    const d=vid.duration;
    if((isFinite(d)&&d>0&&vid.currentTime>=d-0.15)||vid.ended) onVideoEnd();
  }
});
</script>
</body>
</html>
