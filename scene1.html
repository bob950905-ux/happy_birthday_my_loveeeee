<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 1 (Final Stable - Fixed Tap Position)</title>
<link rel="stylesheet" href="./assets/ui.css"/>
<style>
.dialog { display: none; } 
.dialog.show { 
    display: block !important; 
    z-index: 9999; 
}

/* íƒ­ì¹©ì„ ëŒ€í™”ì°½ ìœ„ë¡œ ë‚´ë¦¼ + ì‚´ì§ í‚¤ì›€ */
.tapchip {
  position: fixed;
  left: 50%;
  bottom: 110px; /* ëŒ€í™”ì°½ ìœ„ìª½ ìœ„ì¹˜ */
  transform: translateX(-50%);
  display: none;
  padding: 12px 18px;
  border-radius: 999px;
  background: rgba(20,28,38,.9);
  color: #fff;
  font-weight: 700;
  font-size: 1rem;
  border: 1px solid rgba(255,255,255,.15);
  box-shadow: 0 4px 18px rgba(0,0,0,.35);
  user-select: none;
  -webkit-user-select: none;
  transition: bottom 0.2s ease;
}
.tapchip:active { transform: translateX(-50%) scale(.96); }
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene1_walk.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div class="hint" id="hint">ğŸ¬ START!</div>
  <div class="tapchip" id="tap">íƒ­!</div>

  <div class="dialog" id="dialog">
    <div class="row" id="row">
      <img class="avatar" id="avatar" src="./assets/avatar_seongwoo.png" alt="avatar"/>
      <div class="bubble" id="bubble">
        <div class="name" id="name">ì„±ìš°</div>
        <div class="line" id="line"></div>
        <div class="center" id="btns"></div>
      </div>
    </div>
  </div>
  <div class="hearts" id="hearts"></div>
</div>

<script>
const vid=document.getElementById('vid');
const hint=document.getElementById('hint');
const tap=document.getElementById('tap');
const dialog=document.getElementById('dialog');
const avatar=document.getElementById('avatar');
const nameEl=document.getElementById('name');
const line=document.getElementById('line');
const btns=document.getElementById('btns');

/* ---------------- TAP ì‹œìŠ¤í…œ ---------------- */
let tapAction=null;
let tapGuard=false;

function setTap(next,label='íƒ­!'){
  tapAction=next;
  tap.textContent=label;
  tap.style.display='inline-flex';
}
function clearTap(){
  tapAction=null;
  tap.style.display='none';
}
function handleTap(e){
  if(e.target!==tap)return;
  e.preventDefault(); e.stopPropagation();
  if(tapGuard)return;
  tapGuard=true; setTimeout(()=>tapGuard=false,200);
  const fn=tapAction; clearTap();
  if(typeof fn==='function')fn();
}
tap.addEventListener('touchend',handleTap,{passive:false});
tap.addEventListener('click',handleTap,{passive:false});
window.addEventListener('click',e=>{
  if(e.target!==tap)e.stopPropagation();
},{capture:true});

/* ---------------- START ë²„íŠ¼ ---------------- */
function setupStart(video,hint){
  hint.style.display='none';
  video.addEventListener('canplay',()=>{hint.style.display='block';},{once:true});
  const start=()=>{
    hint.style.display='none';
    video.muted=true; video.playsInline=true;
    video.play().catch(()=>{ setTap(()=>{video.play();},'íƒ­!'); });
  };
  ['click','touchend','pointerdown'].forEach(ev=>{
    document.addEventListener(ev,start,{once:true,passive:true});
  });
}

/* ---------------- ëŒ€í™”ì°½ í‘œì‹œ ---------------- */
function showDialog(text, avatarSrc='./assets/avatar_seongwoo.png', who='ì„±ìš°'){
  dialog.classList.add('show');
  avatar.src=avatarSrc;
  nameEl.textContent=who;
  line.textContent=text;
  btns.innerHTML='';
}

/* ---------------- ì‹¤í–‰ íë¦„ ---------------- */
setupStart(vid,hint);

vid.addEventListener('ended',()=>{
  setTap(()=>{
    showDialog('ì–´? ê½ƒì´ë„¤.');
    setTap(()=>{
      showDialog('ê²¨ìš¸ì— ë¬´ìŠ¨ ê½ƒì´ ë‹¤ í”¼ì—ˆëŒ€.');
      setTap(()=>{
        showDialog('ê·¸ë˜ë„... ì˜ˆì˜ë‹¤.');
        btns.innerHTML='';
        const home=document.createElement('a');
        home.href='./index.html';
        home.className='btn';
        home.textContent='ë‹¤ìŒ ì„ ë¬¼ ê³ ë¥´ëŸ¬ ê°€ê¸° ğŸ';
        btns.appendChild(home);
      });
    });
  });
},{once:true});
</script>
</body>
</html>
