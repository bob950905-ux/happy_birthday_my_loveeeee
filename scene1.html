<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 1 (Final Robust)</title>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:sans-serif;}
video{width:100vw;height:100vh;object-fit:contain}

/* ÎåÄÌôîÏ∞Ω */
.dialog{display:none;}
.dialog.show{display:block!important;z-index:10050!important;}
.row{display:flex;align-items:flex-end;gap:12px;padding:0 18px;position:fixed;left:0;right:0;bottom:28px;}
.avatar{width:58px;height:58px;border-radius:10px;object-fit:cover}
.bubble{flex:1;background:rgba(19,25,36,.92);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;color:#eaf1ff}
.name{font-weight:800;margin-bottom:6px}
.line{font-weight:700;font-size:1.05rem;line-height:1.55}
.center{margin-top:12px}

/* ÌÉ≠Ïπ©(Ïî¨2 Í∏∞Ï§Ä ÌÜµÏùº) */
.tapchip{
  position:fixed!important;left:50%;bottom:110px;transform:translateX(-50%);
  display:none;padding:15px 30px;border-radius:999px;background:rgba(20,28,38,.9);
  color:#fff;font-weight:700;font-size:1.2rem;border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);width:auto!important;height:auto!important;white-space:nowrap;
  z-index:10060!important;
}
.tapchip:active{transform:translateX(-50%) scale(.96)}

/* START Î≤ÑÌäº */
#hint{
  position:fixed;left:50%;top:18px;transform:translateX(-50%);
  padding:10px 14px;border-radius:999px;background:rgba(20,28,38,.9);
  color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);z-index:10001;
}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene1_walk.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div id="hint">üé¨ START!</div>
  <div id="tap" class="tapchip">ÌÉ≠!</div>

  <div id="dialog" class="dialog">
    <div class="row">
      <img id="avatar" class="avatar" src="./assets/avatar_seongwoo.png" alt="avatar">
      <div class="bubble">
        <div id="name" class="name">ÏÑ±Ïö∞</div>
        <div id="line" class="line"></div>
        <div id="btns" class="center"></div>
      </div>
    </div>
  </div>
</div>

<script>
const vid   = document.getElementById('vid');
const hint  = document.getElementById('hint');
const tap   = document.getElementById('tap');
const dialog= document.getElementById('dialog');
const avatar= document.getElementById('avatar');
const nameEl= document.getElementById('name');
const line  = document.getElementById('line');
const btns  = document.getElementById('btns');

/* ÌÉ≠Ïπ© */
let tapAction=null, tapGuard=false;
function setTap(next){ tapAction=next; tap.style.display='inline-flex'; }
function clearTap(){ tapAction=null; tap.style.display='none'; }
function fireTap(){
  if(tapGuard) return;
  tapGuard=true; setTimeout(()=>tapGuard=false,150);
  const fn=tapAction; clearTap(); if(typeof fn==='function') fn();
}
tap.addEventListener('click', fireTap);
tap.addEventListener('touchend', e=>{ e.preventDefault(); fireTap(); });

/* START */
function setupStart(){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none';
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=> setTap(()=> vid.play() ));
    ['click','touchend','pointerdown'].forEach(ev=>document.removeEventListener(ev,start));
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

/* ÎåÄÏÇ¨ */
function showDialog(text, who='ÏÑ±Ïö∞', face='./assets/avatar_seongwoo.png'){
  dialog.classList.add('show');
  avatar.src = face;
  nameEl.textContent = who;
  line.textContent = text;
  btns.innerHTML = '';
}

/* Ï¢ÖÎ£å Ï≤òÎ¶¨(ÎåÄÏÇ¨ Ï≤¥Ïù∏) */
let endHandled = false;
function onVideoEnd(){
  if(endHandled) return;
  endHandled = true;

  // 1
  showDialog('Ïñ¥? ÍΩÉÏù¥ÎÑ§.');
  setTap(()=> {
    // 2
    showDialog('Í≤®Ïö∏Ïóê Î¨¥Ïä® ÍΩÉÏù¥ Îã§ ÌîºÏóàÎåÄ.');
    setTap(()=> {
      // 3
      showDialog('Í∑∏ÎûòÎèÑ... ÏòàÏÅòÎã§.');
      setTap(()=> {
        clearTap();
        const home=document.createElement('a');
        home.href='./index.html';
        home.className='btn';
        home.textContent='Îã§Ïùå ÏÑ†Î¨º Í≥†Î•¥Îü¨ Í∞ÄÍ∏∞ üéÅ';
        btns.appendChild(home);
      });
    });
  });
}

/* Ïã§Ìñâ */
setupStart();

/* 1) ÌëúÏ§Ä ended */
vid.addEventListener('ended', onVideoEnd, { once:true });

/* 2) ÏõåÏπòÎèÖ: duration Í∏∞Î∞ò Ìè¥ÎßÅ */
let poll = null;
const startPoll = () => {
  if (poll) return;
  poll = setInterval(()=>{
    const d = vid.duration;
    if (isFinite(d) && d > 0 && vid.currentTime >= d - 0.15) onVideoEnd();
    if (vid.ended) onVideoEnd();
  }, 120);
};
vid.addEventListener('loadedmetadata', startPoll, { once:true });
vid.addEventListener('playing', startPoll, { once:true });

/* 3) ÏµúÌõÑ ÏàòÎã®: ÌïòÎìú ÌÉÄÏûÑÏïÑÏõÉ (ÎπÑÎîîÏò§ Í∏∏Ïù¥ Î™®Î•¥Î©¥ 20Ï¥à) */
let hardTimeout = setTimeout(()=> onVideoEnd(), 20000);
vid.addEventListener('loadedmetadata', ()=>{
  if (isFinite(vid.duration) && vid.duration > 0) {
    clearTimeout(hardTimeout);
    hardTimeout = setTimeout(()=> onVideoEnd(), Math.ceil(vid.duration*1000)+1500);
  }
}, { once:true });

/* 4) ÏÇ¨Ïö©ÏûêÍ∞Ä Î®ºÏ†Ä ÌÉ≠ÌñàÎäîÎç∞ Ïã§ÏùÄ ÏòÅÏÉÅÏù¥ Ïù¥ÎØ∏ ÎÅùÏûêÎùΩÏù¥ÏóàÏùÑ Ïàò ÏûàÎäî ÎåÄÎπÑ */
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible') {
    const d = vid.duration;
    if ((isFinite(d) && d > 0 && vid.currentTime >= d - 0.15) || vid.ended) onVideoEnd();
  }
});
</script>
</body>
</html>
