<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Scene 1 (Tap Fix & Unified)</title>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:sans-serif;}
video{width:100vw;height:100vh;object-fit:contain;}

/* ëŒ€í™”ì°½ */
.dialog{display:none;}
.dialog.show{display:block!important;z-index:10050!important;}
.row{display:flex;align-items:flex-end;gap:12px;padding:0 18px;position:fixed;left:0;right:0;bottom:28px;}
.avatar{width:58px;height:58px;border-radius:10px;object-fit:cover;}
.bubble{flex:1;background:rgba(19,25,36,.92);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;color:#eaf1ff;}
.name{font-weight:800;margin-bottom:6px;}
.line{font-weight:700;font-size:1.05rem;line-height:1.55;}
.center{margin-top:12px;}

/* âœ… íƒ­ì¹©: ì”¬2 ê¸°ì¤€ìœ¼ë¡œ í†µì¼ (ëŒ€ì‚¬ì°½ ìœ„, bottom:110px) */
.tapchip{
  position:fixed!important;left:50%;bottom:110px;transform:translateX(-50%);
  display:none;padding:15px 30px;border-radius:999px;background:rgba(20,28,38,.9);
  color:#fff;font-weight:700;font-size:1.2rem;border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);width:auto!important;height:auto!important;white-space:nowrap;
  z-index:10060!important;
}
.tapchip:active{transform:translateX(-50%) scale(.96);}

/* START ë²„íŠ¼ */
#hint{
  position:fixed;left:50%;top:18px;transform:translateX(-50%);
  padding:10px 14px;border-radius:999px;background:rgba(20,28,38,.9);
  color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.15);
  box-shadow:0 4px 18px rgba(0,0,0,.35);z-index:10001;
}
</style>
</head>
<body>
<div class="stage">
  <video id="vid" src="./scene1_walk.mp4" preload="auto" playsinline webkit-playsinline muted></video>
  <div id="hint">ğŸ¬ START!</div>
  <div id="tap" class="tapchip">íƒ­!</div>

  <div id="dialog" class="dialog">
    <div class="row">
      <img id="avatar" class="avatar" src="./assets/avatar_seongwoo.png" alt="avatar">
      <div class="bubble">
        <div id="name" class="name">ì„±ìš°</div>
        <div id="line" class="line"></div>
        <div id="btns" class="center"></div>
      </div>
    </div>
  </div>
</div>

<script>
const vid   = document.getElementById('vid');
const hint  = document.getElementById('hint');
const tap   = document.getElementById('tap');
const dialog= document.getElementById('dialog');
const avatar= document.getElementById('avatar');
const nameEl= document.getElementById('name');
const line  = document.getElementById('line');
const btns  = document.getElementById('btns');

/* --- íƒ­ì¹© ì œì–´ (ì”¬2ì™€ ë™ì¼) --- */
let tapAction=null, tapGuard=false;
function setTap(next){ tapAction=next; tap.style.display='inline-flex'; }
function clearTap(){ tapAction=null; tap.style.display='none'; }
function fireTap(){
  if(tapGuard) return;
  tapGuard=true; setTimeout(()=>tapGuard=false,150);
  const fn=tapAction; clearTap(); if(typeof fn==='function') fn();
}
tap.addEventListener('click', fireTap);
tap.addEventListener('touchend', e=>{ e.preventDefault(); fireTap(); });

/* --- START --- */
function setupStart(){
  hint.style.display='block';
  const start=()=>{
    hint.style.display='none';
    vid.muted=true; vid.playsInline=true;
    vid.play().catch(()=> setTap(()=> vid.play() ));
    ['click','touchend','pointerdown'].forEach(ev=>document.removeEventListener(ev,start));
  };
  ['click','touchend','pointerdown'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));
}

/* --- ëŒ€ì‚¬ --- */
function showDialog(text, who='ì„±ìš°', face='./assets/avatar_seongwoo.png'){
  dialog.classList.add('show');
  avatar.src = face;
  nameEl.textContent = who;
  line.textContent = text;
  btns.innerHTML = '';
}

/* --- ì‹¤í–‰ --- */
setupStart();

/* âœ… í•µì‹¬: ended ì´í›„ setTap ì²´ì¸ì´ í™•ì‹¤íˆ ê±¸ë¦¬ë„ë¡ once ë¦¬ìŠ¤ë„ˆ + ì¦‰ì‹œ showDialog + setTap */
vid.addEventListener('ended', ()=> {
  // 1
  showDialog('ì–´? ê½ƒì´ë„¤.');
  setTap(()=> {
    // 2
    showDialog('ê²¨ìš¸ì— ë¬´ìŠ¨ ê½ƒì´ ë‹¤ í”¼ì—ˆëŒ€.');
    setTap(()=> {
      // 3
      showDialog('ê·¸ë˜ë„... ì˜ˆì˜ë‹¤.');
      setTap(()=> {
        clearTap();
        const home=document.createElement('a');
        home.href='./index.html';
        home.className='btn';
        home.textContent='ë‹¤ìŒ ì„ ë¬¼ ê³ ë¥´ëŸ¬ ê°€ê¸° ğŸ';
        btns.appendChild(home);
      });
    });
  });
}, { once:true });
</script>
</body>
</html>
