<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ğŸ ë¦¬ë³¸ í’€ê¸° â€” ì‹œê°„ì°¨ ì˜¤í”ˆ</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html,body { margin:0; background:#000; overflow:hidden; font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; }
  .stage { position:fixed; inset:0; }

  /* ë°°ê²½ ì˜ìƒ */
  video{
    position:absolute; inset:0; width:100vw; height:100vh;
    object-fit:contain; background:#000; z-index:0; display:block;
  }

  /* ğŸ€ ë¦¬ë³¸ í’€ê¸° (ì¤‘ì•™) */
  #hint{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:16px 22px; border-radius:16px;
    background:linear-gradient(135deg,#ff90c2,#ff68b5);
    color:#1a1020; font-weight:900; font-size:1.05rem;
    border:1px solid rgba(255,255,255,.22);
    box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 0 22px rgba(255,255,255,.25);
    z-index:5; user-select:none; animation:bob 1.6s ease-in-out infinite;
  }
  #hint:active{ transform:translate(-50%,-50%) scale(.98); }
  @keyframes bob{ 0%,100%{ transform:translate(-50%,-50%) translateY(0);} 50%{transform:translate(-50%,-50%) translateY(-6px);} }

  /* í•˜íŠ¸ ë²„íŠ¼ ë°” (í•˜ë‹¨ë³´ë‹¤ â€˜ì¡°ê¸ˆ ìœ„â€™) */
  .heart-bar{
    position:fixed; left:0; right:0;
    bottom:calc(env(safe-area-inset-bottom,0px) + 140px);
    display:flex; gap:12px; justify-content:center; align-items:flex-end;
    padding:0 16px; z-index:10; pointer-events:none; /* ì• ë‹ˆ ì¤‘ í„°ì¹˜ ë°©ì§€ */
    visibility:hidden; /* ì¤€ë¹„ ìƒíƒœ */
  }

  /* ë²„íŠ¼ ê¸°ë³¸ */
  .btn-heart{
    position:relative; display:inline-flex; align-items:center; justify-content:center;
    min-width:120px; padding:12px 16px;
    border-radius:999px; font-weight:900; letter-spacing:.3px;
    color:#0c1020; text-decoration:none; user-select:none;
    border:1px solid rgba(255,255,255,.14);
    box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 18px rgba(255,255,255,.15);
    transform:translateY(20px); opacity:0; filter:saturate(1.08);
    transition:transform .6s ease-out, opacity .6s ease-out, box-shadow .2s ease;
    pointer-events:auto;
  }
  .btn-heart:active{ transform:translateY(0) scale(.98); }

  /* ìƒ‰ìƒ */
  .pink  { background:linear-gradient(45deg,#ff90c2,#ff68b5); }
  .orange{ background:linear-gradient(45deg,#ffc076,#ff8a33); }
  .blue  { background:linear-gradient(45deg,#7cc8ff,#3fa6ff); }

  /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
  .show { opacity:1; transform:translateY(0); }

  /* ì ê¸ˆ ìƒíƒœ */
  .locked{ filter:grayscale(.15) brightness(.9); opacity:.65; cursor:not-allowed; }
  .locked .lock{
    position:absolute; left:50%; bottom:-26px; transform:translateX(-50%);
    padding:6px 10px; border-radius:10px;
    background:rgba(16,22,32,.9); color:#eaf1ff; font-weight:800; font-size:.78rem;
    border:1px solid rgba(255,255,255,.14); white-space:nowrap;
  }
  .locked .lock b{ font-variant-numeric:tabular-nums; }

  /* ì¢ì€ ë†’ì´ ëŒ€ì‘ */
  @media (max-height:740px){
    .btn-heart{ min-width:110px; padding:10px 14px; }
    .heart-bar{ bottom:calc(env(safe-area-inset-bottom,0px) + 120px); gap:10px; }
  }
</style>
</head>
<body>
  <div class="stage">
    <!-- ì„ ë¬¼ìƒì ì˜¤í”„ë‹ ì˜ìƒ -->
    <video id="vid" src="./gift_open.mp4" preload="auto" playsinline webkit-playsinline muted></video>
    <div id="hint">ğŸ€ ë¦¬ë³¸ í’€ê¸°</div>

    <!-- í•˜ë‹¨ í•˜íŠ¸ ë²„íŠ¼ë“¤ -->
    <div id="bar" class="heart-bar" aria-label="ì„ ë¬¼ ì„ íƒ">
      <a class="btn-heart pink"   href="./scene1.html"   id="btn1" aria-label="ì²«ë²ˆì§¸">ğŸ’–</a>
      <a class="btn-heart orange" href="./scene2.html"   id="btn2" aria-label="ë‘ë²ˆì§¸">ğŸ§¡ğŸ§¡</a>
      <a class="btn-heart blue"   href="./scene3_4.html" id="btn3" aria-label="ì„¸ë²ˆì§¸">ğŸ’™ğŸ’™ğŸ’™</a>
    </div>
  </div>

<script>
  /* ===================== ì›í•˜ëŠ” ì„¤ì •ë§Œ ì—¬ê¸° ë°”ê¾¸ë©´ ë ===================== */
  const STAGGER_MS = 4000;                // í•˜íŠ¸ ë“±ì¥ ê°„ê²©(ë°€ë¦¬ì´ˆ) => 4ì´ˆ
  const UNLOCK_OFFSETS = [0, 3600, 7200]; // ì ê¸ˆ í•´ì œ(ì´ˆ) => ì¦‰ì‹œ/1ì‹œê°„/2ì‹œê°„
  const KEY_START_AT = 'giftStartAt';     // ì ê¸ˆ íƒ€ì´ë¨¸ ê¸°ì¤€ ì €ì¥ í‚¤
  /* ======================================================================= */

  const vid  = document.getElementById('vid');
  const hint = document.getElementById('hint');
  const bar  = document.getElementById('bar');
  const btns = [document.getElementById('btn1'), document.getElementById('btn2'), document.getElementById('btn3')];

  /* ---------- ìœ í‹¸ ---------- */
  const nowSec = () => Math.floor(Date.now()/1000);
  const fmtHMS = (sec)=>{const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60,p=n=>String(n).padStart(2,'0');return `${p(h)}:${p(m)}:${p(s)}`;};

  function lock(btn){
    if(btn.dataset.locked==='1') return;
    btn.dataset.locked='1'; btn.classList.add('locked');
    let badge=btn.querySelector('.lock'); if(!badge){badge=document.createElement('span'); badge.className='lock'; badge.innerHTML='ğŸ”’ <b>--:--:--</b>'; btn.appendChild(badge);}
    btn.addEventListener('click',prevent,{capture:true});
  }
  function unlock(btn){
    if(btn.dataset.locked!=='1') return;
    btn.dataset.locked='0'; btn.classList.remove('locked');
    const b=btn.querySelector('.lock'); if(b) b.remove();
    btn.removeEventListener('click',prevent,{capture:true});
    btn.style.boxShadow='0 10px 28px rgba(0,0,0,.4), inset 0 0 22px rgba(255,255,255,.25)';
    setTimeout(()=>{btn.style.boxShadow='0 8px 24px rgba(0,0,0,.35), inset 0 0 18px rgba(255,255,255,.15)';},250);
  }
  function prevent(e){ e.preventDefault(); e.stopPropagation(); const t=e.currentTarget; t.style.transform='translateY(0) scale(.97)'; setTimeout(()=>t.style.transform='translateY(0)',120); }

  function revealButtons(){
    bar.style.visibility='visible';
    bar.style.pointerEvents='none';
    btns.forEach((b,i)=> setTimeout(()=>b.classList.add('show'), i*STAGGER_MS) );
    setTimeout(()=> bar.style.pointerEvents='auto', (btns.length-1)*STAGGER_MS + 300);
  }

  function ensureStartAt(){
    let t = localStorage.getItem(KEY_START_AT);
    if(!t){ t = String(nowSec()); localStorage.setItem(KEY_START_AT, t); }
    return parseInt(t,10);
  }

  function scheduleLocks(){
    const startAt = ensureStartAt();

    // ì´ˆê¸° ìƒíƒœ ë°˜ì˜
    btns.forEach((btn,i)=>{
      const remain = startAt + UNLOCK_OFFSETS[i] - nowSec();
      if(remain<=0){ unlock(btn); }
      else{ lock(btn); const b=btn.querySelector('.lock b'); if(b) b.textContent = fmtHMS(remain); }
    });

    // ë§¤ì´ˆ ê°±ì‹ 
    setInterval(()=>{
      const n = nowSec();
      btns.forEach((btn,i)=>{
        const remain = startAt + UNLOCK_OFFSETS[i] - n;
        if(remain<=0){ unlock(btn); }
        else if(btn.dataset.locked==='1'){ const b=btn.querySelector('.lock b'); if(b) b.textContent=fmtHMS(remain); }
      });
    },1000);
  }

  /* ---------- ì²« ë°©ë¬¸(ì˜ìƒ) / ì¬ë°©ë¬¸(ë°”ë¡œ í•˜íŠ¸) ---------- */
  function firstRunFlow(){
    hint.style.display='block';
    const start=()=>{
      hint.style.display='none';
      vid.muted=true; vid.playsInline=true;
      vid.play().catch(()=>{ // ì‹¤íŒ¨ ì‹œ ë°”ë¡œ í•˜íŠ¸ í”Œë¡œìš°
        vid.style.display='none';
        revealButtons(); scheduleLocks();
      });
      ['pointerdown','touchend','click'].forEach(ev=>document.removeEventListener(ev,start));
    };
    ['pointerdown','touchend','click'].forEach(ev=>document.addEventListener(ev,start,{once:true,passive:true}));

    // ì˜ìƒ ëë‚˜ë©´ í•˜íŠ¸
    let done=false;
    const finish=()=>{ if(done) return; done=true; vid.style.display='none'; revealButtons(); scheduleLocks(); };
    vid.addEventListener('ended',finish,{once:true});
    vid.addEventListener('timeupdate',()=>{ if(!done && vid.duration && vid.currentTime>=vid.duration-0.2) finish(); });
    vid.addEventListener('error',finish,{once:true});
  }

  function returnFlow(){
    // í™ˆ ì¬ë°©ë¬¸ì´ë©´: ì˜ìƒ/íŒíŠ¸ ìˆ¨ê¸°ê³  ë°”ë¡œ í•˜íŠ¸
    hint.style.display='none';
    vid.style.display='none';
    revealButtons();
    scheduleLocks();
  }

  /* ---------- ì§„ì… íŒë‹¨ ---------- */
  if(localStorage.getItem(KEY_START_AT)){
    // ì´ë¯¸ í•œ ë²ˆ ì—´ì–´ë³¸ ìƒíƒœ â†’ ì˜ìƒ ìŠ¤í‚µ
    returnFlow();
  }else{
    // ì²« ë°©ë¬¸ â†’ ì˜ìƒ ë³´ê³  ì—´ê¸°
    firstRunFlow();
  }

  // í•„ìš”ì‹œ ê°•ì œ ë¦¬ì…‹: index.html?reset=1
  if(new URLSearchParams(location.search).get('reset')==='1'){
    localStorage.removeItem(KEY_START_AT);
    location.replace(location.pathname);
  }
</script>
</body>
</html>
