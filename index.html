<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ğŸ ë¦¬ë³¸ í’€ê¸°</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html,body { margin:0; background:#000; color:#fff; font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; overflow:hidden; }
  .stage { position:fixed; inset:0; }

  /* ì˜ìƒì€ í™”ë©´ ê°€ë“ (ì„¸ë¡œ ë¹„ìœ¨ ìœ ì§€) */
  video {
    position:absolute; inset:0; width:100vw; height:100vh;
    object-fit:contain; background:#000; z-index:0; display:none;
  }

  /* ì¤‘ì•™ ë¦¬ë³¸ ë²„íŠ¼ */
  .start {
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:14px 22px; border-radius:999px; font-weight:900; font-size:1.05rem;
    background:linear-gradient(45deg,#ffd6f0,#ff8ac6); color:#15192a;
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 10px 28px rgba(0,0,0,.45);
    z-index:10; user-select:none;
  }
  .start:active { transform:translate(-50%,-50%) scale(.98); }

  /* í•˜íŠ¸ ë²„íŠ¼ ë°” (í•˜ë‹¨ ì¡°ê¸ˆ ìœ„) */
  .heart-bar{
    position:fixed; left:0; right:0;
    bottom:calc(env(safe-area-inset-bottom,0px) + 135px);
    display:none; gap:14px; justify-content:center;
    padding:0 16px; z-index:11; pointer-events:none;
  }
  .heart{
    pointer-events:auto; position:relative; min-width:120px; padding:12px 16px;
    border-radius:999px; font-weight:900; color:#0c1020;
    border:1px solid rgba(255,255,255,.14); box-shadow:0 10px 26px rgba(0,0,0,.42);
    opacity:0; transform:translateY(18px) scale(.96);
    transition:opacity .6s cubic-bezier(.16,.84,.44,1), transform .6s cubic-bezier(.16,.84,.44,1);
  }
  .heart.show { opacity:1; transform:translateY(0) scale(1); }
  .heart:active { transform:translateY(0) scale(.98); }
  .pink   { background:linear-gradient(45deg,#ff90c2,#ff68b5); }
  .orange { background:linear-gradient(45deg,#ffc076,#ff8a33); }
  .blue   { background:linear-gradient(45deg,#7cc8ff,#3fa6ff); }
  .heart.locked { filter:grayscale(1); opacity:.55; pointer-events:none; }
  .locknote{
    position:absolute; left:50%; bottom:-26px; transform:translateX(-50%);
    font-size:.82rem; color:#bcc6d8; white-space:nowrap; user-select:none; text-shadow:0 1px 3px #000;
  }

  @media (max-height:740px){
    .heart-bar{ bottom:calc(env(safe-area-inset-bottom,0px) + 118px); gap:10px; }
    .heart{ min-width:110px; padding:10px 14px; }
  }
</style>
</head>
<body>
<div class="stage">
  <!-- ì„ ë¬¼ìƒì ì˜¤í”„ë‹ ì˜ìƒ (ê²½ë¡œë§Œ ë§ì¶°ë‘ë©´ ë¨) -->
  <video id="giftVideo" src="./assets/gift_box.mp4" preload="auto" playsinline webkit-playsinline muted></video>

  <!-- ì¤‘ì•™ ë¦¬ë³¸ ë²„íŠ¼ -->
  <button id="startBtn" class="start">ğŸ€ ë¦¬ë³¸ í’€ê¸°</button>

  <!-- í•˜íŠ¸ 3ê°œ: 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ìˆœì°¨ ë“±ì¥, ì ê¸ˆì€ ì‹œê°„ì°¨ë¡œ -->
  <nav class="heart-bar" id="heartBar">
    <a class="heart pink"   id="h1" href="./scene1.html">ğŸ’–</a>
    <a class="heart orange" id="h2" href="./scene2.html">ğŸ§¡ğŸ§¡</a>
    <a class="heart blue"   id="h3" href="./scene3_4.html">ğŸ’™ğŸ’™ğŸ’™</a>
  </nav>
</div>

<script>
/* ================= ì„¤ì • ================= */
const VIDEO_SRC = './assets/gift_box.mp4';   // ì„ ë¬¼ìƒì ì˜ìƒ ê²½ë¡œ
const STAGGER_MS = 5000;                     // í•˜íŠ¸ ë“±ì¥ ê°„ê²©(ë°€ë¦¬ì´ˆ) â€” 5ì´ˆ
// í…ŒìŠ¤íŠ¸: [0,10,20] / ì‹¤ì‚¬ìš©: [0,3600,7200] (ì´ˆ ë‹¨ìœ„)
const UNLOCK_OFFSETS = [0, 3600, 7200];
const BASE_KEY = 'gift_unlock_plan';

/* ================ DOM ================ */
const startBtn = document.getElementById('startBtn');
const videoEl  = document.getElementById('giftVideo');
const heartBar = document.getElementById('heartBar');
const hearts   = [...document.querySelectorAll('.heart')];

/* ================ ìœ í‹¸ ================ */
function fmtRemain(ms){
  if (ms<=0) return '';
  const s=Math.ceil(ms/1000);
  const h=Math.floor(s/3600);
  const m=Math.floor((s%3600)/60);
  const sec=s%60;
  if(h>0) return `â° ${h}ì‹œê°„ ${m}ë¶„ ë’¤ì— ì—´ë ¤ìš”`;
  if(m>0) return `â° ${m}ë¶„ ${sec}ì´ˆ ë’¤ì— ì—´ë ¤ìš”`;
  return `â° ${sec}ì´ˆ ë’¤ì— ì—´ë ¤ìš”`;
}
function ensurePlan(){
  let plan = JSON.parse(localStorage.getItem(BASE_KEY)||'null');
  if(!Array.isArray(plan)){
    const now = Date.now();
    plan = UNLOCK_OFFSETS.map(sec => now + sec*1000);
    localStorage.setItem(BASE_KEY, JSON.stringify(plan));
  }
  return plan;
}

/* ===== ì ê¸ˆ ìƒíƒœ í‘œì‹œ & ì‹¤ì‹œê°„ ë‚¨ì€ì‹œê°„ ===== */
function setupLocks(){
  const plan = ensurePlan();
  // ê° í•˜íŠ¸ì— ë‚¨ì€ì‹œê°„ í‘œì‹œ DOM ë§Œë“¤ê¸°
  hearts.forEach((btn)=>{
    let note = btn.querySelector('.locknote');
    if(!note){
      note = document.createElement('div');
      note.className='locknote';
      btn.appendChild(note);
    }
  });
  function tick(){
    const now = Date.now();
    plan.forEach((deadline,i)=>{
      const btn  = hearts[i];
      const note = btn.querySelector('.locknote');
      const remain = deadline - now;
      if(remain<=0){
        btn.classList.remove('locked');
        note.textContent = '';
      }else{
        btn.classList.add('locked');
        note.textContent = fmtRemain(remain);
      }
    });
    requestAnimationFrame(tick);
  }
  tick();
}

/* ===== ì˜ìƒ ì¢…ë£Œ â†’ í•˜íŠ¸ í‘œì‹œ ===== */
function revealHearts(){
  heartBar.style.display='flex';
  setupLocks();
  hearts.forEach((h,i)=>{
    setTimeout(()=>h.classList.add('show'), i*STAGGER_MS);
  });
}

/* ========== ë¦¬ë³¸ í’€ê¸° â†’ ë°”ë¡œ ì˜ìƒ ì¬ìƒ (íƒ­ ì—†ìŒ) ========== */
startBtn.addEventListener('click', async () => {
  // iOS/Safari ì„±ê³µë¥ ì„ ìœ„í•´ ì¬ìƒ ì „ì— ì†ì„±/í”Œë˜ê·¸ í™•ì‹¤íˆ ì„¸íŒ…
  videoEl.muted = true;
  videoEl.setAttribute('muted','');                 // ì¼ë¶€ ë¸Œë¼ìš°ì € í˜¸í™˜
  videoEl.playsInline = true;
  videoEl.setAttribute('playsinline','');
  videoEl.setAttribute('webkit-playsinline','');
  videoEl.src = VIDEO_SRC;                           // (ê²½ë¡œ ë°˜ë“œì‹œ ì¡´ì¬)

  startBtn.style.display='none';
  videoEl.style.display='block';

  try {
    // ìœ ì € ì œìŠ¤ì²˜ ì•ˆì—ì„œ play â†’ ìë™ì¬ìƒ í—ˆìš©ë¨
    await videoEl.play();
  } catch (err) {
    // ë§Œì•½ ì‹¤íŒ¨í•˜ë”ë¼ë„ íë¦„ ë§‰ì§€ ë§ê³ : ì˜ìƒ ê±´ë„ˆë›°ê³  í•˜íŠ¸ ë°”ë¡œ ë…¸ì¶œ
    console.warn('Video play failed, fallback to hearts:', err);
    videoEl.style.display='none';
    revealHearts();
    return;
  }
});

/* ì˜ìƒì´ ì •ìƒ ì¬ìƒë˜ë©´, ëë‚  ë•Œ í•˜íŠ¸ ì˜¤í”ˆ */
videoEl.addEventListener('ended', revealHearts);
/* ë§‰í”„ë ˆì„ ì§ì „ ë³´ì • */
videoEl.addEventListener('timeupdate', ()=>{
  if(videoEl.duration && videoEl.currentTime >= videoEl.duration - 0.2){
    videoEl.dispatchEvent(new Event('ended'));
  }
});

/* ---- í•„ìš” ì‹œ ë¦¬ì…‹: ?reset=1 ---- */
if (new URLSearchParams(location.search).get('reset') === '1'){
  localStorage.removeItem(BASE_KEY);
}
</script>
</body>
</html>


