<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ğŸ ë¦¬ë³¸ í’€ê¸° â€” ì‹œê°„ì°¨ ì„ ë¬¼</title>
<style>
:root { color-scheme: dark; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html,body { margin:0; background:#000; font-family: system-ui,-apple-system,"Noto Sans KR",sans-serif; }
.stage { position:fixed; inset:0; overflow:hidden; }

/* ë¹„ë””ì˜¤ëŠ” ë§¨ ë’¤ */
video {
  position:absolute; inset:0; width:100vw; height:100vh;
  object-fit:contain; background:#000; z-index:0 !important;
}

/* ë¸”ë™ ì˜¤ë²„ë ˆì´ (ì˜ìƒ ëë‚˜ë©´ í˜ì´ë“œì¸) */
#black {
  position:absolute; inset:0; background:#000;
  opacity:0; pointer-events:none; z-index:5;
  transition: opacity .6s ease;
}

/* ìƒë‹¨ íŒíŠ¸ */
#hint {
  position:fixed; left:50%; top:16px; transform:translateX(-50%);
  padding:10px 14px; border-radius:999px; background:rgba(20,28,38,.92);
  color:#fff; font-weight:800; border:1px solid rgba(255,255,255,.15);
  box-shadow:0 6px 22px rgba(0,0,0,.35); z-index:10; user-select:none;
}

/* ì¤‘ì•™ ë¦¬ë³¸ ë²„íŠ¼ */
#ribbon {
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  display:inline-flex; align-items:center; gap:10px;
  padding:14px 20px; border-radius:16px; background:#1f2a3a;
  color:#fff; border:1px solid rgba(255,255,255,.18); font-weight:900;
  box-shadow:0 8px 26px rgba(0,0,0,.4); z-index:12;
}
#ribbon:active { transform:translate(-50%,-50%) scale(.98); }

/* ë²„íŠ¼ ë± (í•˜ë‹¨) */
#deck {
  position:fixed; left:0; right:0; bottom:calc(env(safe-area-inset-bottom,0px) + 22px);
  display:none; justify-content:center; gap:10px; flex-wrap:wrap; padding:0 14px; z-index:20;
}
.btn {
  min-width:160px;
  display:inline-flex; align-items:center; justify-content:center;
  padding:12px 14px; border-radius:12px; font-weight:800;
  background:#30435f; color:#fff; border:1px solid rgba(255,255,255,.12);
  text-decoration:none; opacity:0; transform:translateY(8px);
  transition: opacity .25s ease, transform .25s ease;
}
.btn.show { opacity:1; transform:translateY(0); }
.btn:active { transform:translateY(1px); }
.btn[disabled] { opacity:.45 !important; filter:grayscale(.3); pointer-events:none; }
.lock { font-size:.9rem; opacity:.9; margin-left:8px; }

/* ì‘ì€ í™”ë©´ ëŒ€ì‘ */
@media (max-height:740px){
  .btn{ padding:10px 12px; min-width:148px; }
}
</style>
</head>
<body>
<div class="stage">
  <!-- ì„ ë¬¼ë°•ìŠ¤ ì—¬ëŠ” ì˜ìƒ (ê²€ì • ë°°ê²½) -->
  <video id="gift" src="gift_open.mp4" preload="auto" playsinline webkit-playsinline muted></video>

  <!-- ë¸”ë™ ì˜¤ë²„ë ˆì´: ì˜ìƒ ëë‚˜ë©´ í˜ì´ë“œì¸í•´ì„œ í™•ì‹¤íˆ ê²€ì • ë°°ê²½ìœ¼ë¡œ -->
  <div id="black"></div>

  <!-- ìƒë‹¨ íŒíŠ¸ & ë¦¬ë³¸ -->
  <div id="hint">ğŸ¬ íƒ­í•´ì„œ ì‹œì‘</div>
  <button id="ribbon">ğŸ€ ë¦¬ë³¸ í’€ê¸°</button>

  <!-- í•˜ë‹¨ ë²„íŠ¼ 3ê°œ -->
  <div id="deck">
    <a id="b1" class="btn" href="./scene1.html">ğŸ’— ì²« ë²ˆì§¸ ì„ ë¬¼</a>
    <a id="b2" class="btn" href="./scene2.html" disabled>ğŸ’™ ë‘ ë²ˆì§¸ ì„ ë¬¼ <span class="lock" id="t2">â³</span></a>
    <a id="b3" class="btn" href="./scene3_4.html" disabled>ğŸ’› ë§ˆì§€ë§‰ ì„ ë¬¼ <span class="lock" id="t3">â³</span></a>
  </div>
</div>

<script>
/* ===== ì„¤ì •: ì‹œê°„ ê°„ê²©(ì‹œê°„ ë‹¨ìœ„) ===== */
const HOURS_2 = 2;  // ë‘ ë²ˆì§¸ ë²„íŠ¼: 2ì‹œê°„ ë’¤ ì˜¤í”ˆ
const HOURS_5 = 5;  // ì„¸ ë²ˆì§¸ ë²„íŠ¼: 5ì‹œê°„ ë’¤ ì˜¤í”ˆ

/* ===== ìš”ì†Œ ===== */
const video  = document.getElementById('gift');
const black  = document.getElementById('black');
const hint   = document.getElementById('hint');
const ribbon = document.getElementById('ribbon');
const deck   = document.getElementById('deck');
const b1     = document.getElementById('b1');
const b2     = document.getElementById('b2');
const b3     = document.getElementById('b3');
const t2     = document.getElementById('t2');
const t3     = document.getElementById('t3');

const LS_KEY = 'giftOpenedAt_v1';

/* ===== ë‚¨ì€ ì‹œê°„ í¬ë§· ===== */
function fmt(ms){
  if(ms <= 0) return 'ì—´ ìˆ˜ ìˆì–´ìš”!';
  const s = Math.ceil(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  if(h>0) return `${h}ì‹œê°„ ${m}ë¶„`;
  if(m>0) return `${m}ë¶„`;
  return `${s}ì´ˆ`;
}

/* ===== ë²„íŠ¼ ìƒíƒœ ê°±ì‹  ===== */
let openedAt = null;
let ticker = null;

function showDeckStaggered(){
  deck.style.display = 'flex';
  // íˆ­Â·íˆ­Â·íˆ­ ë“±ì¥
  requestAnimationFrame(()=>{
    setTimeout(()=> b1.classList.add('show'), 0);
    setTimeout(()=> b2.classList.add('show'), 180);
    setTimeout(()=> b3.classList.add('show'), 360);
  });
}

function updateLocks(){
  if(!openedAt) return;
  const now = Date.now();
  const base = Number(openedAt);
  const after2 = base + HOURS_2*60*60*1000;
  const after5 = base + HOURS_5*60*60*1000;

  // 1ë²ˆì€ ì¦‰ì‹œ
  b1.removeAttribute('disabled');

  // 2ë²ˆ
  const left2 = after2 - now;
  if(left2 <= 0){
    b2.removeAttribute('disabled');
    if(t2) t2.textContent = 'âœ¨ ì—´ë ¸ì–´ìš”';
  }else{
    b2.setAttribute('disabled','');
    if(t2) t2.textContent = 'â³ ' + fmt(left2);
  }

  // 3ë²ˆ
  const left5 = after5 - now;
  if(left5 <= 0){
    b3.removeAttribute('disabled');
    if(t3) t3.textContent = 'âœ¨ ì—´ë ¸ì–´ìš”';
  }else{
    b3.setAttribute('disabled','');
    if(t3) t3.textContent = 'â³ ' + fmt(left5);
  }
}

/* ===== ì²« ë°©ë¬¸ì´ ì•„ë‹Œ ê²½ìš°(ì´ë¯¸ ì—´ì–´ë³¸ ì  ìˆìŒ): ë°”ë¡œ ë¸”ë™+ë²„íŠ¼ ===== */
function coldStart(){
  const saved = localStorage.getItem(LS_KEY);
  if(saved){
    openedAt = Number(saved);
    // ì˜ìƒ ìˆ¨ê¸°ê³  ë¸”ë™ ì¼œê¸°
    try { video.pause(); } catch(e){}
    video.style.display = 'none';
    black.style.opacity = 1; // ì´ë¯¸ ê²€ì •ìœ¼ë¡œ
    hint.style.display = 'none';
    ribbon.style.display = 'none';
    showDeckStaggered();
    updateLocks();
    ticker = setInterval(updateLocks, 1000);
    return true;
  }
  return false;
}

/* ===== ë¦¬ë³¸ í’€ê¸° â†’ ì˜ìƒ ì¬ìƒ â†’ ëë‚˜ë©´ ë¸”ë™ í˜ì´ë“œ + ë²„íŠ¼ ===== */
function setupPlay(){
  ribbon.addEventListener('click', async ()=>{
    hint.style.display = 'none';
    ribbon.style.display = 'none';

    // iOS/Safari ëŒ€ë¹„
    video.muted = true;
    video.playsInline = true;

    try { await video.play(); }
    catch(e){
      // ìë™ì¬ìƒ ì‹¤íŒ¨ ì‹œ í•œ ë²ˆ ë” íƒ­ ìœ ë„
      hint.textContent = 'â–¶ï¸ íƒ­í•´ì„œ ì¬ìƒ';
      hint.style.display = 'block';
      const once = ()=>{ hint.style.display='none'; video.play().catch(()=>{}); video.removeEventListener('click', once); };
      video.addEventListener('click', once, {once:true});
    }
  }, {passive:true});

  const finish = ()=>{
    if(!openedAt){
      openedAt = Date.now();
      localStorage.setItem(LS_KEY, String(openedAt));
    }
    // í™•ì‹¤í•œ ë¸”ë™ ì „í™˜
    black.style.opacity = 1;
    // ì ê¹ì˜ í˜ì´ë“œ í›„ ë²„íŠ¼ ë…¸ì¶œ
    setTimeout(()=>{
      showDeckStaggered();
      updateLocks();
      ticker = setInterval(updateLocks, 1000);
      // ë¹„ë””ì˜¤ëŠ” ì•ˆ ë³´ì´ê²Œ
      video.style.display = 'none';
    }, 200);
  };

  video.addEventListener('ended', finish, {once:true});
  video.addEventListener('timeupdate', ()=>{
    if(video.duration && video.currentTime >= video.duration - 0.2){
      video.dispatchEvent(new Event('ended'));
    }
  });
}

/* ===== ì‹œì‘ ===== */
if(!coldStart()){
  hint.style.display = 'block';
  ribbon.style.display = 'inline-flex';
  setupPlay();
}
</script>
</body>
</html>
