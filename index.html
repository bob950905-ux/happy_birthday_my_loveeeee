<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ğŸ ë¦¬ë³¸ í’€ê¸°</title>
<style>
  :root { color-scheme: dark; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html,body { margin:0; background:#000; color:#fff; font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif; overflow:hidden; }
  .stage { position:fixed; inset:0; }

  video {
    position:absolute; inset:0; width:100vw; height:100vh;
    object-fit:contain; background:#000; z-index:0;
  }

  .start {
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:14px 22px; border-radius:999px; font-weight:900;
    background:linear-gradient(45deg,#ffd6f0,#ff8ac6); color:#15192a;
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 10px 28px rgba(0,0,0,.45);
    z-index:10; user-select:none;
  }
  .start:active { transform:translate(-50%,-50%) scale(.98); }

  .tapchip{
    position:fixed; left:50%;
    bottom:calc(env(safe-area-inset-bottom,0px) + 120px);
    transform:translateX(-50%);
    display:none; padding:12px 18px; border-radius:999px;
    background:rgba(20,28,38,.9); color:#fff; font-weight:800;
    border:1px solid rgba(255,255,255,.15); box-shadow:0 6px 22px rgba(0,0,0,.35);
    z-index:12;
  }

  .heart-bar{
    position:fixed; left:0; right:0;
    bottom:calc(env(safe-area-inset-bottom,0px) + 135px);
    display:flex; gap:14px; justify-content:center;
    padding:0 16px; z-index:11;
    pointer-events:none;
  }

  .heart{
    pointer-events:auto;
    position:relative;
    min-width:120px; padding:12px 16px;
    border-radius:999px; font-weight:900;
    color:#0c1020;
    border:1px solid rgba(255,255,255,.14);
    box-shadow:0 10px 26px rgba(0,0,0,.42);
    opacity:0; transform:translateY(18px) scale(.96);
    transition:opacity .6s cubic-bezier(.16,.84,.44,1), transform .6s cubic-bezier(.16,.84,.44,1);
  }
  .heart.show { opacity:1; transform:translateY(0) scale(1); }
  .heart:active { transform:translateY(0) scale(.98); }

  .pink   { background:linear-gradient(45deg,#ff90c2,#ff68b5); }
  .orange { background:linear-gradient(45deg,#ffc076,#ff8a33); }
  .blue   { background:linear-gradient(45deg,#7cc8ff,#3fa6ff); }

  .heart.locked { filter:grayscale(1); opacity:.55; pointer-events:none; }
  .locknote{
    position:absolute; left:50%; bottom:-26px; transform:translateX(-50%);
    font-size:.82rem; color:#bcc6d8; text-shadow:0 1px 3px #000;
    white-space:nowrap; user-select:none;
  }

  @media (max-height:740px){
    .heart-bar{ bottom:calc(env(safe-area-inset-bottom,0px) + 118px); gap:10px; }
    .heart{ min-width:110px; padding:10px 14px; }
  }
</style>
</head>
<body>
<div class="stage">
  <video id="giftVideo" src="assets/gift_box.mp4" preload="auto" playsinline webkit-playsinline muted style="display:none;"></video>

  <button id="startBtn" class="start">ğŸ€ ë¦¬ë³¸ í’€ê¸°</button>
  <button id="tap" class="tapchip">íƒ­!</button>

  <nav class="heart-bar" id="heartBar" style="display:none;">
    <a class="heart pink"   id="h1" href="./scene1.html">ğŸ’–</a>
    <a class="heart orange" id="h2" href="./scene2.html">ğŸ§¡ğŸ§¡</a>
    <a class="heart blue"   id="h3" href="./scene3_4.html">ğŸ’™ğŸ’™ğŸ’™</a>
  </nav>
</div>

<script>
/* ===== ì„¤ì • ===== */
const VIDEO_SRC = 'assets/gift_box.mp4';
const STAGGER_MS = 5000;        // í•˜íŠ¸ ë“±ì¥ ê°„ê²© (5ì´ˆ)
const UNLOCK_OFFSETS = [0, 3600, 7200]; // í…ŒìŠ¤íŠ¸: [0,10,20]
const BASE_KEY = 'gift_unlock_plan';

/* ===== ì´ˆê¸°í™” ===== */
if (new URLSearchParams(location.search).get('reset') === '1'){
  localStorage.removeItem(BASE_KEY);
}

const startBtn=document.getElementById('startBtn');
const tapChip=document.getElementById('tap');
const videoEl=document.getElementById('giftVideo');
const heartBar=document.getElementById('heartBar');
const hearts=[...document.querySelectorAll('.heart')];

/* ===== ìœ í‹¸ ===== */
function fmtRemain(ms){
  if (ms<=0) return 'ì—´ ìˆ˜ ìˆì–´ìš”!';
  const s=Math.ceil(ms/1000);
  const h=Math.floor(s/3600);
  const m=Math.floor((s%3600)/60);
  const sec=s%60;
  if(h>0)return`â° ${h}ì‹œê°„ ${m}ë¶„ ë’¤ì— ì—´ë ¤ìš”`;
  if(m>0)return`â° ${m}ë¶„ ${sec}ì´ˆ ë’¤ì— ì—´ë ¤ìš”`;
  return`â° ${sec}ì´ˆ ë’¤ì— ì—´ë ¤ìš”`;
}

function ensurePlan(){
  let arr=JSON.parse(localStorage.getItem(BASE_KEY)||'null');
  if(!Array.isArray(arr)){
    const now=Date.now();
    arr=UNLOCK_OFFSETS.map(sec=>now+sec*1000);
    localStorage.setItem(BASE_KEY,JSON.stringify(arr));
  }
  return arr;
}

/* ===== ì ê¸ˆ í‘œì‹œ ===== */
function setupLocks(){
  const plan=ensurePlan();
  hearts.forEach((btn,i)=>{
    const note=document.createElement('div');
    note.className='locknote';
    btn.appendChild(note);
  });

  function tick(){
    const now=Date.now();
    plan.forEach((t,i)=>{
      const btn=hearts[i];
      const note=btn.querySelector('.locknote');
      const remain=t-now;
      if(remain<=0){
        btn.classList.remove('locked');
        note.textContent='';
      }else{
        btn.classList.add('locked');
        note.textContent=fmtRemain(remain);
      }
    });
    requestAnimationFrame(tick);
  }
  tick();
}

/* ===== ì˜ìƒ ëë‚˜ë©´ í•˜íŠ¸ í‘œì‹œ ===== */
function revealHearts(){
  heartBar.style.display='flex';
  setupLocks();
  hearts.forEach((h,i)=>{
    setTimeout(()=>h.classList.add('show'),i*STAGGER_MS);
  });
}

/* ===== ì‹œì‘ë²„íŠ¼ í´ë¦­ ===== */
startBtn.addEventListener('click',async()=>{
  startBtn.style.display='none';
  videoEl.style.display='block';
  videoEl.src=VIDEO_SRC;
  try{await videoEl.play();}
  catch(e){
    tapChip.style.display='block';
    const play=async()=>{
      tapChip.style.display='none';
      await videoEl.play().catch(()=>{});
    };
    tapChip.addEventListener('click',play,{once:true});
    tapChip.addEventListener('touchend',play,{once:true});
  }
});

videoEl.addEventListener('ended',()=>revealHearts());
videoEl.addEventListener('timeupdate',()=>{
  if(videoEl.duration&&videoEl.currentTime>=videoEl.duration-0.2){
    videoEl.dispatchEvent(new Event('ended'));
  }
});
</script>
</body>
</html>

